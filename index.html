<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBAM Gap-Analyse Template</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Poppins', sans-serif;
      line-height:1.6; background:white;
      min-height:100vh; color:#000;
    }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    .header { background:white; border-radius:15px; padding:30px; text-align:center; margin-bottom:30px; box-shadow:0 10px 30px rgba(6,4,150,0.1); border:2px solid #060496; }
    .header h1 { color:#060496; font-size:2.5em; margin-bottom:10px; font-weight:700; }

    .deadline-warning{
      background:#060496; color:white; padding:15px; border-radius:10px;
      margin:20px 0; text-align:center; font-weight:600; font-size:1.1em;
    }

    .financial-projection{ background:#060496; color:white; padding:25px; border-radius:15px; margin:20px 0; }
    .projection-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin:20px 0; }
    .projection-card{ background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; border-left:5px solid #fff; }

    .commission-reminder{ background:#ff6b35; color:white; padding:25px; border-radius:15px; margin:20px 0; }

    .sector-selector{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .sector-btn{
      background:white; border:3px solid #e0e0e0; border-radius:15px; padding:20px; text-align:center; cursor:pointer;
      transition:all .3s ease; box-shadow:0 5px 15px rgba(0,0,0,.1);
    }
    .sector-btn:hover, .sector-btn.active{ border-color:#060496; background:#f8f9fa; transform:translateY(-2px); }
    .sector-icon{ font-size:2em; margin-bottom:10px; }

    .gap-analysis{ background:white; border-radius:15px; padding:30px; margin:20px 0; box-shadow:0 10px 30px rgba(6,4,150,0.1); border:2px solid #060496; display:none; }
    .gap-analysis.active{ display:block; }

    .question-block{ background:#f8f9fa; border-left:5px solid #060496; padding:20px; margin:15px 0; border-radius:5px; }
    .question-title{ font-weight:600; color:#000; margin-bottom:10px; font-size:1.1em; }

    .status-grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:15px; }
    .status-option{ padding:10px; border-radius:8px; text-align:center; cursor:pointer; border:2px solid transparent; transition:all .3s ease; }
    .status-have{ background:#d4edda; color:#155724; }
    .status-partial{ background:#fff3cd; color:#856404; }
    .status-need{ background:#f8d7da; color:#721c24; }
    .status-option:hover, .status-option.selected{ border-color:#060496; transform:scale(1.02); }

    .company-info{ background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px; border:2px solid #060496; }
    .info-row{ display:grid; grid-template-columns:200px 1fr; gap:15px; margin:10px 0; align-items:center; }
    .info-label{ font-weight:600; color:#000; }
    .info-input{ padding:8px 12px; border:2px solid #060496; border-radius:5px; font-size:14px; }
    .info-input:focus{ outline:none; border-color:#060496; box-shadow:0 0 0 3px rgba(6,4,150,0.1); }
    .required{ color:#e74c3c; }

    .results-section{
      background:#060496; color:white; padding:25px; border-radius:15px; margin-top:30px;
    }
    .action-item{ background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; margin:10px 0; border-left:4px solid #fff; }
    .priority-high{ border-left-color:#e74c3c; }
    .priority-medium{ border-left-color:#f39c12; }
    .priority-low{ border-left-color:#27ae60; }

    .generate-btn{
      background:#060496; color:white; border:none; padding:15px 30px; border-radius:10px; font-size:1.1em; cursor:pointer;
      margin:20px auto; display:block; transition:all .3s ease; font-weight:600;
    }
    .generate-btn:hover{ background:#050385; transform:scale(1.05); }

    .austria-germany-info{ background:#060496; color:white; padding:25px; border-radius:15px; margin:20px 0; }

    .cost-comparison{ background:#060496; color:white; padding:20px; border-radius:15px; margin:20px 0; }
    .comparison-table{ display:grid; grid-template-columns:1fr 1fr; gap:20px; margin:15px 0; }
    .comparison-card{ background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; }
    
    .validation-error{ border-color:#e74c3c !important; }
    .error-message{ color:#e74c3c; font-size:12px; margin-top:5px; }

    .chart-container{ background:rgba(255,255,255,0.1); padding:25px; border-radius:10px; margin:25px 0; }
    .chart-wrapper{ position:relative; height:400px; background:white; border-radius:8px; padding:15px; }
    #projectionChart{ width:100%!important; height:100%!important; }
    
    @media (max-width:700px){ .status-grid{ grid-template-columns:1fr; } .info-row{ grid-template-columns:1fr; } .comparison-table{ grid-template-columns:1fr; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 20px;">
        <svg width="160" height="48" viewBox="0 0 320 96" style="flex-shrink: 0;">
          <text x="0" y="65" font-family="Poppins, sans-serif" font-size="38" font-weight="400" fill="#060496">entrenovu.</text>
        </svg>
        <div style="text-align: right;">
          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
            Powered by <a href="https://www.entrenovu.com/" target="_blank" style="color: #060496; text-decoration: none; font-weight: 500;">entrenovu</a>
          </div>
        </div>
      </div>
      <h1>◯ CBAM Gap-Analyse</h1>
      <p>Für österreichische und deutsche Importeure</p>
    </div>

    <div class="deadline-warning">
      ⚠ CBAM-Vollphase startet am 1. Januar 2026 - Die Zeit zur Vorbereitung läuft ab!
    </div>

    <div class="commission-reminder">
      <h2 style="margin-bottom:20px;">📢 Wichtiger Hinweis der EU-Kommission</h2>
      <p><strong>Die EU-Kommission wird im Oktober 2025 die finalen Daten und Methoden für die endgültige CBAM-Phase veröffentlichen.</strong></p>
      <p style="margin-top:15px; font-size:1.1em;">
        🔖 <strong>Bookmarken Sie dieses Tool!</strong> Sobald die endgültigen EU-Daten veröffentlicht sind, werden wir unsere Kostenprognosen entsprechend aktualisieren, damit Sie genauere Kalkulationen erhalten.
      </p>
      <p style="margin-top:10px; font-style:italic;">
        Unsere aktuellen Berechnungen basieren auf RALEPA-Prognosen und EU-Benchmark-Werten der Übergangsphase.
      </p>
    </div>

    <div class="financial-projection">
      <h2 style="margin-bottom:20px;">▲ CBAM-Kostenprognose 2026-2034</h2>
      <p><strong>CO₂-Preise:</strong> 90€/t (2026) → 178€/t (2034) - Basierend auf RALEPA-Prognosen</p>

      <div class="projection-grid">
        <div class="projection-card">
          <h4>■ CBAM-Kosten über 9 Jahre (RALEPA)</h4>
          <ul style="margin:10px 0; line-height:1.8;">
            <li><strong>2026:</strong> 90€/t CO₂</li>
            <li><strong>2028:</strong> 108€/t CO₂</li>
            <li><strong>2030:</strong> 138€/t CO₂</li>
            <li><strong>2032:</strong> 158€/t CO₂</li>
            <li><strong>2034:</strong> 178€/t CO₂</li>
          </ul>
        </div>

        <div class="projection-card">
          <h4>⚖ Vorbereitete vs. Unvorbereitete Importeure</h4>
          <p><strong>Mit akkuraten Lieferantendaten:</strong></p>
          <ul style="line-height:1.6;">
            <li>Reale CBAM-Kosten (niedriger)</li>
            <li>Wettbewerbsvorteil</li>
            <li>Bessere Lieferantenbeziehungen</li>
          </ul>
          <p><strong>Mit EU-Standardwerten (Default):</strong></p>
          <ul style="line-height:1.6;">
            <li>+15-25% höhere CBAM-Kosten</li>
            <li>Wettbewerbsnachteil</li>
            <li>Risiko von Lieferantenwechsel</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="cost-comparison">
      <h3>▼ Kostenvergleich: Vorbereitet vs. Unvorbereitet</h3>
      <div class="comparison-table">
        <div class="comparison-card">
          <h4>✓ Unternehmen mit Lieferantendaten (Optimiert)</h4>
          <p><strong>Stahl:</strong> ~2.30 t CO₂/t Produkt = 207€ CBAM/t</p>
          <p><strong>Aluminium:</strong> ~10.50 t CO₂/t Produkt = 945€ CBAM/t</p>
          <p><strong>Zement:</strong> ~0.85 t CO₂/t Produkt = 77€ CBAM/t</p>
          <p><strong>Dünger:</strong> ~1.50 t CO₂/t Produkt = 135€ CBAM/t</p>
        </div>
        <div class="comparison-card">
          <h4>✗ Unternehmen mit EU-Standardwerten</h4>
          <p><strong>Stahl:</strong> ~2.80 t CO₂/t = 252€ CBAM/t (+22%)</p>
          <p><strong>Aluminium:</strong> ~11.50 t CO₂/t = 1035€ CBAM/t (+10%)</p>
          <p><strong>Zement:</strong> ~0.97 t CO₂/t = 87€ CBAM/t (+13%)</p>
          <p><strong>Dünger:</strong> ~1.72 t CO₂/t = 155€ CBAM/t (+15%)</p>
        </div>
      </div>
      <p style="text-align:center; margin-top:15px; font-size:1.1em;">
        <strong>▲ Bei 1000 t Import/Jahr: Der Unterschied kann 10.000€ - 90.000€ zusätzliche Kosten pro Jahr bedeuten!</strong>
      </p>
    </div>

    <div class="austria-germany-info">
      <h2>◆ Spezielle Informationen für österreichische und deutsche Importeure</h2>

      <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin:15px 0;">
        <h3>▲ CBAM-Deklarant-Autorisierung erforderlich</h3>
        <p><strong>Ab 1. Januar 2026:</strong> Nur autorisierte CBAM-Deklaranten dürfen CBAM-Waren importieren</p>
        <p><strong>Antragsverfahren:</strong> Über die nationale Behörde Ihres Mitgliedstaats</p>
        <p><strong>Deadline:</strong> Anträge ab März 2025 möglich - rechtzeitig beantragen!</p>
      </div>

      <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin:15px 0;">
        <h3>▲ Ihre Hauptaufgaben als Importeur</h3>
        <ul style="line-height:1.8; margin:10px 0;">
          <li>🏭 <strong>Lieferantenmanagement:</strong> Emissionsdaten von Nicht-EU-Lieferanten sammeln</li>
          <li>📊 <strong>Quartalsberichte:</strong> Bis Ende 2025 weiterhin erforderlich</li>
          <li>💰 <strong>CBAM-Zertifikate:</strong> Ab 2026 kaufen und abgeben</li>
          <li>✅ <strong>Verifizierung:</strong> Ab 2026 durch akkreditierte Prüfer</li>
          <li>📋 <strong>Jahresdeklaration:</strong> Bis 31. Mai (ab 2027 für 2026)</li>
        </ul>
      </div>

      <div style="background:rgba(255,255,255,0.2); padding:20px; border-radius:10px; margin:15px 0;">
        <h3>◯ Wichtige CBAM-Schwellenwerte</h3>
        <p><strong>Neue 50-Tonnen-Regel:</strong> Importeure unter 50 t/Jahr sind von der Berichtspflicht befreit</p>
        <p><strong>Aber:</strong> Gilt nicht für Wasserstoff und Elektrizität - dort sind alle Importe erfasst</p>
        <p><strong>Sanktionen:</strong> 10-50€ pro Tonne nicht gemeldeter Emissionen (Übergangsphase)</p>
        <p><strong>Ab 2026:</strong> 100€ pro fehlende CBAM-Zertifikat - ohne Obergrenze!</p>
      </div>
    </div>

    <!-- CBAM Cost Calculator -->
    <div class="cost-calculator-section" style="background:#f8f9fa; padding:25px; border-radius:15px; margin:20px 0; border:2px solid #060496;">
      <h2 style="color:#060496; margin-bottom:20px; font-weight:700;">💰 CBAM-Kostenschätzer (CN-Code basiert)</h2>
      
      <div style="background:#fff3cd; border:2px solid #856404; padding:15px; border-radius:8px; margin-bottom:20px; color:#856404;">
        <h4 style="margin-bottom:10px;">⚠ Wichtiger Hinweis zu den Berechnungen</h4>
        <p>Diese Kostenschätzungen basieren auf <strong>EU-Übergangsphase-Daten und CN-Code spezifischen Emissionswerten</strong>. Die Berechnungen berücksichtigen EU-Benchmarks und CBAM Phase-in Faktoren (97,5% für 2026).</p>
        <p style="margin-top:10px;"><strong>Für präzise Kalkulationen</strong> mit echten Lieferantendaten kontaktieren Sie Entrenovu für eine maßgeschneiderte Analyse.</p>
      </div>

      <div id="product-calculator">
        <h3 style="margin-bottom:15px;">Fügen Sie Ihre CBAM-Produkte hinzu:</h3>
        <div id="products-container"></div>
        <button type="button" onclick="addProduct()" style="background:#060496; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin:10px 0;">+ Produkt hinzufügen</button>
      </div>
      
      <div id="cost-summary" style="display:none; background:#060496; color:white; padding:20px; border-radius:10px; margin-top:20px;">
        <h3>📊 CBAM Kosten Prognose</h3>
        <div id="total-costs-content"></div>
        <div class="chart-container" id="cost-chart-container" style="display:none; margin-top:20px;">
          <div class="chart-wrapper">
            <canvas id="costProjectionChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Company info -->
    <div class="company-info">
      <h3 style="margin-bottom:15px; color:#000;">■ Unternehmensdaten</h3>
      <div class="info-row">
        <div class="info-label">Firmenname: <span class="required">*</span></div>
        <div>
          <input type="text" class="info-input" id="company-name" placeholder="z.B. Austrian Steel Import GmbH" required>
          <div class="error-message" id="company-name-error"></div>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">Ihr Name: <span class="required">*</span></div>
        <div>
          <input type="text" class="info-input" id="contact-name" placeholder="z.B. Max Mustermann" required>
          <div class="error-message" id="contact-name-error"></div>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">E-Mail: <span class="required">*</span></div>
        <div>
          <input type="email" class="info-input" id="contact-email" placeholder="z.B. max.mustermann@firma.at" required>
          <div class="error-message" id="contact-email-error"></div>
        </div>
      </div>
      <div class="info-row">
        <div class="info-label">Hauptlieferanten (Länder):</div>
        <input type="text" class="info-input" id="eu-buyers" placeholder="z.B. Türkei, Ukraine, Serbien, China">
      </div>
      <div class="info-row">
        <div class="info-label">Unternehmensgröße:</div>
        <select class="info-input" id="company-size">
          <option value="">Bitte wählen...</option>
          <option value="small">Klein (< 50 Mitarbeiter)</option>
          <option value="medium">Mittel (50-250 Mitarbeiter)</option>
          <option value="large">Groß (> 250 Mitarbeiter)</option>
        </select>
      </div>
    </div>

    <h3 style="color:#060496; text-align:center; margin:20px 0; font-weight:600;">CBAM-Compliance-Bereitschaftscheck:</h3>

    <!-- CBAM COMPLIANCE READINESS CHECK -->
    <div id="compliance-analysis" class="gap-analysis" style="display:block;">
      <h2 style="color:#060496; margin-bottom:20px; font-weight:700;">✅ CBAM-Compliance-Bereitschaftscheck für Importeure</h2>

      <div class="question-block">
        <div class="question-title">1. CBAM-Deklarant-Autorisierung</div>
        <p><strong>Pflicht ab 1. Januar 2026:</strong> Nur autorisierte CBAM-Deklaranten dürfen CBAM-Waren importieren.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Erledigt<br><small>Autorisierung beantragt/erhalten</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ In Planung<br><small>Vorbereitung läuft</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Noch nicht begonnen<br><small>Keine Maßnahmen eingeleitet</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">2. Lieferanten-Datensammlung & -management</div>
        <p><strong>Kernaufgabe:</strong> Systematische Sammlung von Emissionsdaten von Nicht-EU-Lieferanten.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Etabliert<br><small>System funktioniert gut</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ Teilweise<br><small>Einige Lieferanten kooperieren</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Fehlt<br><small>Keine strukturierte Datensammlung</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">3. CBAM-Registry & Berichtssystem</div>
        <p><strong>Technische Infrastruktur:</strong> Zugang und Nutzung der CBAM-Registry für Quartalsberichte.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Betriebsbereit<br><small>Regelmäßige Berichte abgegeben</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ Teilweise<br><small>Zugang vorhanden, Nutzung sporadisch</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Nicht vorbereitet<br><small>Kein Zugang oder Training</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">4. Interne CBAM-Organisation & Prozesse</div>
        <p><strong>Teamwork:</strong> Koordination zwischen Einkauf, Finanzen, Import und Compliance-Funktionen.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Gut organisiert<br><small>Klare Rollen & Prozesse</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ In Aufbau<br><small>Teilweise definiert</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Fehlend<br><small>Keine klaren Zuständigkeiten</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">5. Finanzplanung für CBAM-Zertifikate</div>
        <p><strong>Budget ab 2026:</strong> Kauf und Abgabe von CBAM-Zertifikaten entsprechend der Importemissionen.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Budgetiert<br><small>Finanzierung gesichert</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ Geplant<br><small>Schätzungen vorhanden</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Ungeplant<br><small>Keine Budgetierung</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">6. Verifizierung & Audit-Bereitschaft</div>
        <p><strong>Ab 2026 verpflichtend:</strong> Unabhängige Verifizierung der CBAM-Berichte durch akkreditierte Prüfer.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Bereit<br><small>Prüfer identifiziert, Systeme auditfähig</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ In Vorbereitung<br><small>Teilweise vorbereitet</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Nicht bereit<br><small>Keine Vorbereitung</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">7. Rechtliche & Compliance-Expertise</div>
        <p><strong>Regulatorisches Wissen:</strong> Verständnis der CBAM-Regularien und laufende Updates zu Änderungen.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Vorhanden<br><small>Experten im Team/extern</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ Grundwissen<br><small>Basiskenntnisse vorhanden</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Fehlt<br><small>Keine Expertise aufgebaut</small></div>
        </div>
      </div>

      <div class="question-block">
        <div class="question-title">8. IT-Systeme & Datenmanagement</div>
        <p><strong>Technische Integration:</strong> CBAM-Datenmanagement in bestehende ERP-Systeme und Controlling-Tools.</p>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this)">✓ Integriert<br><small>Systeme funktionieren</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this)">◐ Teilweise<br><small>Manuelle Prozesse</small></div>
          <div class="status-option status-need" onclick="selectStatus(this)">✗ Nicht vorbereitet<br><small>Keine IT-Lösung</small></div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="results" style="display:none;">
      <h2 style="margin-bottom:20px;">▼ Ergebnisse der CBAM Gap-Analyse</h2>
      <div id="results-content"></div>
      
      <!-- Cost Projection Chart -->
      <div class="chart-container">
        <h3 style="margin-bottom:20px; text-align:center; color:white;">📈 CBAM-Kostenprognose 2026-2034 (RALEPA)</h3>
        <div class="chart-wrapper">
          <canvas id="projectionChart"></canvas>
        </div>
        <div style="margin-top:15px; font-size:0.9em; text-align:center; color:#ddd;">
          <p>💡 <strong>Hinweis:</strong> Die Grafik zeigt, wie die CBAM-Kosten bis 2034 ansteigen werden (RALEPA-Prognosen)</p>
          <p>🎯 Gut vorbereitete Unternehmen können bis zu 20% gegenüber Standardwerten sparen</p>
        </div>
      </div>
      
      <div style="text-align:center; margin-top:30px;">
        <button class="generate-btn" onclick="submitToGoogleSheets()" id="submitBtn">
          ✉️ Ergebnisse senden & kostenlose Beratung anfordern
        </button>
        <p style="margin-top:10px; font-size:0.9em;">Die Ergebnisse werden an Entrenovu zur detaillierten Analyse gesendet</p>
      </div>
    </div>

    <button class="generate-btn" onclick="generateResults()">
      ◉ Gap-Analyse erstellen
    </button>
  </div>

  <script>
    let selectedSector = '';
    let sectorData = {};
    let projectionChart = null;
    let costProjectionChart = null;
    let products = [];
    let productCounter = 0;

    // RALEPA carbon price forecast data (EUA prices)
    const ralepaPrices = {
      2026: 90,
      2027: 95,
      2028: 108, 
      2029: 120,
      2030: 138,
      2031: 148,
      2032: 158,
      2033: 168,
      2034: 178
    };

    // CBAM phase-in factors
    const cbamPhaseIn = {
      2026: 0.975, // Special phase-in factor for 2026
      2027: 1.0,
      2028: 1.0,
      2029: 1.0,
      2030: 1.0,
      2031: 1.0,
      2032: 1.0,
      2033: 1.0,
      2034: 1.0
    };

    // Comprehensive CN code database with emission values and benchmarks
    const cnCodeDatabase = {
      // CEMENT
      "2507 00 80": { sector: "Cement", product: "Calcined clay", direct: 0.23, indirect: 0.08, total: 0.32, benchmark: null },
      "2523 10 00": { sector: "Cement", product: "Cement clinker", direct: 0.83, indirect: 0.04, total: 0.87, benchmark: 0.693 },
      "2523 21 00": { sector: "Cement", product: "White Portland cement", direct: 1.16, indirect: 0.10, total: 1.26, benchmark: 0.957 },
      "2523 29 00": { sector: "Cement", product: "Other Portland cement", direct: 0.81, indirect: 0.06, total: 0.87, benchmark: 0.693 },
      "2523 30 00": { sector: "Cement", product: "Aluminous cement", direct: 1.75, indirect: 0.15, total: 1.90, benchmark: 0.693 },
      "2523 90 00": { sector: "Cement", product: "Other hydraulic cements", direct: 0.59, indirect: 0.04, total: 0.63, benchmark: 0.693 },
      
      // FERTILISERS
      "2808 00 00": { sector: "Fertilisers", product: "Nitric acid", direct: 2.56, indirect: 0.05, total: 2.60, benchmark: 0.230 },
      "2814": { sector: "Fertilisers", product: "Ammonia", direct: 2.68, indirect: 0.14, total: 2.82, benchmark: 1.570 },
      "2834 21 00": { sector: "Fertilisers", product: "Nitrates of potassium", direct: 1.82, indirect: 0.06, total: 1.88, benchmark: 0.230 },
      "3102 10": { sector: "Fertilisers", product: "Urea", direct: 1.78, indirect: 0.12, total: 1.90, benchmark: 1.570 },
      "3102 21 00": { sector: "Fertilisers", product: "Ammonium sulphate", direct: 0.86, indirect: 0.09, total: 0.94, benchmark: 1.570 },
      "3102 29 00": { sector: "Fertilisers", product: "Double salts ammonium", direct: 1.54, indirect: 0.10, total: 1.63, benchmark: 1.570 },
      "3102 30": { sector: "Fertilisers", product: "Ammonium nitrate", direct: 2.32, indirect: 0.07, total: 2.39, benchmark: 1.570 },
      "3102 40": { sector: "Fertilisers", product: "CAN mixtures", direct: 1.77, indirect: 0.06, total: 1.84, benchmark: 1.570 },
      "3102 50 00": { sector: "Fertilisers", product: "Sodium nitrate", direct: 3.99, indirect: 0.07, total: 4.06, benchmark: 0.230 },
      "3102 60 00": { sector: "Fertilisers", product: "Calcium nitrate mixtures", direct: 1.87, indirect: 0.08, total: 1.95, benchmark: 1.570 },
      "3102 80 00": { sector: "Fertilisers", product: "UAN solution", direct: 1.28, indirect: 0.06, total: 1.34, benchmark: 1.570 },
      "3102 90 00": { sector: "Fertilisers", product: "Other nitrogen fertilisers", direct: 1.65, indirect: 0.10, total: 1.74, benchmark: 1.570 },
      "3105 10 00": { sector: "Fertilisers", product: "NPK tablets", direct: 0.94, indirect: 0.08, total: 1.02, benchmark: 1.570 },
      "3105 20": { sector: "Fertilisers", product: "NPK fertilisers", direct: 1.23, indirect: 0.11, total: 1.35, benchmark: 1.570 },
      "3105 30 00": { sector: "Fertilisers", product: "DAP", direct: 0.69, indirect: 0.06, total: 0.75, benchmark: 1.570 },
      "3105 40 00": { sector: "Fertilisers", product: "MAP", direct: 0.44, indirect: 0.05, total: 0.49, benchmark: 1.570 },
      "3105 51 00": { sector: "Fertilisers", product: "N-P fertilisers", direct: 1.29, indirect: 0.11, total: 1.40, benchmark: 1.570 },
      "3105 59 00": { sector: "Fertilisers", product: "Other N-P fertilisers", direct: 1.29, indirect: 0.11, total: 1.40, benchmark: 1.570 },
      "3105 90": { sector: "Fertilisers", product: "Other NPK", direct: 0.94, indirect: 0.08, total: 1.02, benchmark: 1.570 },
      
      // ALUMINIUM
      "7601": { sector: "Aluminium", product: "Unwrought aluminium", direct: 2.36, indirect: 8.14, total: 10.49, benchmark: 1.464 },
      "7603": { sector: "Aluminium", product: "Aluminium powders", direct: 2.48, indirect: 8.40, total: 10.88, benchmark: 1.464 },
      "7604 10 10": { sector: "Aluminium", product: "Aluminium bars (not alloyed)", direct: 2.31, indirect: 7.49, total: 9.80, benchmark: 1.464 },
      "7604 10 90": { sector: "Aluminium", product: "Aluminium profiles (not alloyed)", direct: 2.73, indirect: 9.30, total: 12.04, benchmark: 1.464 },
      "7604 21 00": { sector: "Aluminium", product: "Hollow aluminium profiles", direct: 2.73, indirect: 9.30, total: 12.04, benchmark: 1.464 },
      "7604 29 10": { sector: "Aluminium", product: "Aluminium alloy bars", direct: 2.31, indirect: 7.49, total: 9.80, benchmark: 1.464 },
      "7604 29 90": { sector: "Aluminium", product: "Aluminium alloy profiles", direct: 2.73, indirect: 9.30, total: 12.04, benchmark: 1.464 },
      "7605": { sector: "Aluminium", product: "Aluminium wire", direct: 2.31, indirect: 7.49, total: 9.80, benchmark: 1.464 },
      "7606": { sector: "Aluminium", product: "Aluminium sheets", direct: 2.86, indirect: 9.25, total: 12.11, benchmark: 1.464 },
      "7607": { sector: "Aluminium", product: "Aluminium foil", direct: 2.86, indirect: 9.25, total: 12.11, benchmark: 1.464 },
      "7608": { sector: "Aluminium", product: "Aluminium tubes", direct: 2.73, indirect: 9.30, total: 12.04, benchmark: 1.464 },
      "7609 00 00": { sector: "Aluminium", product: "Aluminium fittings", direct: 2.73, indirect: 9.30, total: 12.04, benchmark: 1.464 },
      "7610": { sector: "Aluminium", product: "Aluminium structures", direct: 2.73, indirect: 9.30, total: 12.04, benchmark: 1.464 },
      "7611 00 00": { sector: "Aluminium", product: "Aluminium tanks", direct: 2.86, indirect: 9.25, total: 12.11, benchmark: 1.464 },
      "7612": { sector: "Aluminium", product: "Aluminium containers", direct: 2.86, indirect: 9.25, total: 12.11, benchmark: 1.464 },
      "7616 99 10": { sector: "Aluminium", product: "Aluminium articles (cast)", direct: 2.48, indirect: 8.40, total: 10.88, benchmark: 1.464 },
      "7616 99 90": { sector: "Aluminium", product: "Other aluminium articles", direct: 2.86, indirect: 9.25, total: 12.11, benchmark: 1.464 },
      
      // HYDROGEN
      "2804 10 00": { sector: "Hydrogen", product: "Hydrogen", direct: 10.4, indirect: 0.0, total: 10.4, benchmark: 6.84 },
      
      // IRON & STEEL (key codes)
      "7201": { sector: "Iron & steel", product: "Pig iron", direct: 1.90, indirect: 0.17, total: 2.07, benchmark: 1.288 },
      "7208": { sector: "Iron & steel", product: "Hot-rolled flat steel ≥600mm", direct: 2.01, indirect: 0.27, total: 2.28, benchmark: 0.215 },
      "7209": { sector: "Iron & steel", product: "Cold-rolled flat steel ≥600mm", direct: 2.03, indirect: 0.36, total: 2.39, benchmark: 0.215 },
      "7210": { sector: "Iron & steel", product: "Coated flat steel ≥600mm", direct: 1.97, indirect: 0.39, total: 2.35, benchmark: 0.215 },
      "7213": { sector: "Iron & steel", product: "Hot-rolled bars/rods", direct: 1.89, indirect: 0.32, total: 2.21, benchmark: 0.215 },
      "7216": { sector: "Iron & steel", product: "Angles/shapes", direct: 1.89, indirect: 0.32, total: 2.21, benchmark: 0.215 }
    };

    // Product categories mapping
    const productCategories = {
      'steel': 'Stahl & Eisen',
      'aluminium': 'Aluminium',
      'cement': 'Zement',
      'fertilizer': 'Düngemittel',
      'custom': 'Benutzerdefiniert'
    };

    // EU Default emission values by product category (tCO2/t) - for fallback
    const cbamDefaultValues = {
      'steel': 2.80,
      'aluminium': 11.50,
      'cement': 0.97,
      'fertilizer': 1.72,
      'custom': 2.00
    };

    function addProduct() {
      productCounter++;
      const container = document.getElementById('products-container');
      
      const productDiv = document.createElement('div');
      productDiv.className = 'product-item';
      productDiv.id = `product-${productCounter}`;
      productDiv.style.cssText = 'background:white; border:2px solid #060496; border-radius:8px; padding:15px; margin:10px 0;';
      
      productDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h4 style="margin:0; color:#060496;">Produkt ${productCounter}</h4>
          <button type="button" onclick="removeProduct(${productCounter})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">Entfernen</button>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px;">
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">CN/HS-Code (optional):</label>
            <input type="text" id="cncode-${productCounter}" placeholder="z.B. 7208" onchange="updateFromCNCode(${productCounter})" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Produktkategorie:</label>
            <select id="category-${productCounter}" onchange="updateProductType(${productCounter})" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
              <option value="">Wählen...</option>
              <option value="steel">Stahl & Eisen</option>
              <option value="aluminium">Aluminium</option>
              <option value="cement">Zement</option>
              <option value="fertilizer">Düngemittel</option>
              <option value="custom">Andere</option>
            </select>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Jährliche Tonnage:</label>
            <input type="number" id="tonnage-${productCounter}" placeholder="z.B. 1000" min="0" oninput="updateProductCostPreview(${productCounter}); updateCostSummary();" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Emissionen (tCO₂/t):</label>
            <input type="number" id="emissions-${productCounter}" step="0.01" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background:#f8f9fa;" readonly>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Benchmark (tCO₂/t):</label>
            <input type="number" id="benchmark-${productCounter}" step="0.01" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background:#f8f9fa;" readonly>
          </div>
        </div>
        
        <div id="product-info-${productCounter}" style="margin-top:10px; padding:10px; background:#e3f2fd; border-radius:5px; display:none;">
          <small id="product-details-${productCounter}"></small>
        </div>
        
        <div id="cost-preview-${productCounter}" style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:5px; display:none;">
          <small style="color:#666;">Geschätzte jährliche CBAM-Kosten 2026: <span id="cost-text-${productCounter}"></span></small>
        </div>
      `;
      
      container.appendChild(productDiv);
    }

    function removeProduct(id) {
      const productDiv = document.getElementById(`product-${id}`);
      if (productDiv) {
        productDiv.remove();
        updateCostSummary();
      }
    }

    function updateFromCNCode(id) {
      const cnCode = document.getElementById(`cncode-${id}`).value.trim();
      const categorySelect = document.getElementById(`category-${id}`);
      const emissionsInput = document.getElementById(`emissions-${id}`);
      const benchmarkInput = document.getElementById(`benchmark-${id}`);
      const productInfo = document.getElementById(`product-info-${id}`);
      const productDetails = document.getElementById(`product-details-${id}`);
      
      if (cnCode && cnCodeDatabase[cnCode]) {
        const data = cnCodeDatabase[cnCode];
        
        // Update category based on CN code
        const categoryMapping = {
          'Cement': 'cement',
          'Fertilisers': 'fertilizer', 
          'Aluminium': 'aluminium',
          'Hydrogen': 'custom',
          'Iron & steel': 'steel'
        };
        
        categorySelect.value = categoryMapping[data.sector] || 'custom';
        emissionsInput.value = data.total;
        benchmarkInput.value = data.benchmark || 0;
        
        productDetails.innerHTML = `<strong>${data.product}</strong> - Sektor: ${data.sector}<br>
          Direkte Emissionen: ${data.direct} tCO₂/t | Indirekte: ${data.indirect} tCO₂/t | 
          Benchmark: ${data.benchmark ? data.benchmark + ' tCO₂/t' : 'Nicht verfügbar'}`;
        productInfo.style.display = 'block';
        
      } else if (cnCode) {
        // CN code entered but not in database
        productDetails.innerHTML = `CN-Code "${cnCode}" nicht in der Datenbank gefunden. Bitte Kategorie manuell auswählen.`;
        productInfo.style.display = 'block';
        emissionsInput.value = '';
        benchmarkInput.value = 0;
      } else {
        // No CN code entered
        productInfo.style.display = 'none';
        emissionsInput.value = '';
        benchmarkInput.value = 0;
      }
      
      updateProductCostPreview(id);
      updateCostSummary();
    }

    function updateProductType(id) {
      const category = document.getElementById(`category-${id}`).value;
      const emissionsInput = document.getElementById(`emissions-${id}`);
      const benchmarkInput = document.getElementById(`benchmark-${id}`);
      const cnCode = document.getElementById(`cncode-${id}`).value.trim();
      
      // Don't override if CN code is already providing data
      if (cnCode && cnCodeDatabase[cnCode]) {
        return;
      }
      
      if (category && category !== 'custom') {
        emissionsInput.value = cbamDefaultValues[category] || 2.00;
        benchmarkInput.value = 0; // Default values don't have benchmarks
      } else if (category === 'custom') {
        emissionsInput.value = cbamDefaultValues.custom;
        benchmarkInput.value = 0;
      } else {
        emissionsInput.value = '';
        benchmarkInput.value = 0;
      }
      
      updateProductCostPreview(id);
      updateCostSummary();
    }

    function calculateCBAMCost(tonnage, emissions, benchmark, euaPrice, year) {
      const phaseInFactor = cbamPhaseIn[year] || 1.0;
      const effectiveBenchmark = benchmark || 0;
      
      // Formula: ((Embedded Emissions - (Benchmark × CBAM Factor)) × EUA Price)
      const cbamEmissions = Math.max(0, emissions - (effectiveBenchmark * phaseInFactor));
      return tonnage * cbamEmissions * euaPrice;
    }

    function updateProductCostPreview(id) {
      const tonnage = parseFloat(document.getElementById(`tonnage-${id}`).value) || 0;
      const emissions = parseFloat(document.getElementById(`emissions-${id}`).value) || 0;
      const benchmark = parseFloat(document.getElementById(`benchmark-${id}`).value) || 0;
      const costPreview = document.getElementById(`cost-preview-${id}`);
      const costText = document.getElementById(`cost-text-${id}`);
      
      if (tonnage > 0 && emissions > 0) {
        const cost2026 = Math.round(calculateCBAMCost(tonnage, emissions, benchmark, ralepaPrices[2026], 2026));
        costText.textContent = `€${cost2026.toLocaleString()}`;
        costPreview.style.display = 'block';
      } else {
        costPreview.style.display = 'none';
      }
    }

    function updateCostSummary() {
      const products = getAllProducts();
      const summary = document.getElementById('cost-summary');
      const content = document.getElementById('total-costs-content');
      const chartContainer = document.getElementById('cost-chart-container');
      
      if (products.length > 0) {
        const costs = {};
        Object.keys(ralepaPrices).forEach(year => {
          costs[year] = products.reduce((sum, product) => {
            return sum + calculateCBAMCost(product.tonnage, product.emissions, product.benchmark, ralepaPrices[year], parseInt(year));
          }, 0);
        });
        
        content.innerHTML = `
          <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px;">
            <div style="text-align:center;">
              <h4>2026</h4>
              <p style="font-size:1.5em; margin:10px 0;">€${Math.round(costs[2026]).toLocaleString()}</p>
              <small>90€/tCO₂ (Phase-in: 97.5%)</small>
            </div>
            <div style="text-align:center;">
              <h4>2030</h4>
              <p style="font-size:1.5em; margin:10px 0;">€${Math.round(costs[2030]).toLocaleString()}</p>
              <small>138€/tCO₂</small>
            </div>
            <div style="text-align:center;">
              <h4>2034</h4>
              <p style="font-size:1.5em; margin:10px 0;">€${Math.round(costs[2034]).toLocaleString()}</p>
              <small>178€/tCO₂</small>
            </div>
          </div>
          <p style="margin-top:15px; text-align:center; color:#ffeb3b;">
            <strong>📈 Kostensteigerung 2026-2034: +${Math.round(((costs[2034] - costs[2026]) / costs[2026]) * 100)}%</strong>
          </p>
        `;
        
        summary.style.display = 'block';
        chartContainer.style.display = 'block';
        
        // Update cost chart
        setTimeout(() => {
          createCostChart(costs);
        }, 100);
      } else {
        summary.style.display = 'none';
        chartContainer.style.display = 'none';
      }
    }

    function createCostChart(costs) {
      const canvas = document.getElementById('costProjectionChart');
      if (!canvas) return;
      
      const years = Object.keys(costs);
      const costValues = Object.values(costs);
      
      // Check if Chart.js is available
      if (typeof Chart === 'undefined') {
        console.log('⚠️ Chart.js not available for cost chart');
        return;
      }

      try {
        const ctx = canvas.getContext('2d');
        
        // Destroy existing chart
        if (costProjectionChart && typeof costProjectionChart.destroy === 'function') {
          costProjectionChart.destroy();
        }

        costProjectionChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: years,
            datasets: [{
              label: 'CBAM Kosten',
              data: costValues,
              borderColor: '#ff6b35',
              backgroundColor: 'rgba(255, 107, 53, 0.1)',
              tension: 0.4,
              borderWidth: 3,
              pointRadius: 6,
              pointBackgroundColor: '#ff6b35',
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: 'white',
                  callback: function(value) {
                    return '€' + Math.round(value).toLocaleString();
                  }
                },
                grid: {
                  color: 'rgba(255,255,255,0.1)'
                }
              },
              x: {
                ticks: {
                  color: 'white'
                },
                grid: {
                  color: 'rgba(255,255,255,0.1)'
                }
              }
            }
          }
        });
        
      } catch (error) {
        console.error('Error creating cost chart:', error);
      }
    }

    function getAllProducts() {
      const products = [];
      const productItems = document.querySelectorAll('.product-item');
      
      productItems.forEach(item => {
        const id = item.id.split('-')[1];
        const category = document.getElementById(`category-${id}`).value;
        const tonnage = parseFloat(document.getElementById(`tonnage-${id}`).value) || 0;
        const emissions = parseFloat(document.getElementById(`emissions-${id}`).value) || 0;
        const benchmark = parseFloat(document.getElementById(`benchmark-${id}`).value) || 0;
        const cncode = document.getElementById(`cncode-${id}`).value;
        
        if (category && tonnage > 0 && emissions > 0) {
          products.push({
            id: id,
            category: category,
            categoryName: productCategories[category],
            tonnage: tonnage,
            emissions: emissions,
            benchmark: benchmark,
            cncode: cncode
          });
        }
      });
      
      return products;
    }

    function selectStatus(element) {
      // Remove selected class from siblings
      const siblings = element.parentNode.querySelectorAll('.status-option');
      siblings.forEach(sibling => sibling.classList.remove('selected'));
      
      // Add selected class to clicked element
      element.classList.add('selected');
    }

    function validateInputs() {
      let isValid = true;
      
      // Clear previous errors
      document.querySelectorAll('.info-input').forEach(input => input.classList.remove('validation-error'));
      document.querySelectorAll('.error-message').forEach(error => error.textContent = '');
      
      // Check required fields
      const requiredFields = [
        { id: 'company-name', name: 'Firmenname' },
        { id: 'contact-name', name: 'Ihr Name' },
        { id: 'contact-email', name: 'E-Mail' }
      ];
      
      requiredFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (!input.value.trim()) {
          input.classList.add('validation-error');
          document.getElementById(field.id + '-error').textContent = field.name + ' ist erforderlich';
          isValid = false;
        }
      });
      
      // Check email format
      const emailInput = document.getElementById('contact-email');
      if (emailInput.value && !emailInput.value.includes('@')) {
        emailInput.classList.add('validation-error');
        document.getElementById('contact-email-error').textContent = 'Bitte geben Sie eine gültige E-Mail-Adresse ein';
        isValid = false;
      }
      
      return isValid;
    }

    function collectComplianceResponses() {
      const questions = document.querySelectorAll('#compliance-analysis .question-block');
      const responses = [];
      
      questions.forEach((question, index) => {
        const title = question.querySelector('.question-title').textContent;
        const selected = question.querySelector('.status-option.selected');
        
        if (selected) {
          let status = 'unknown';
          if (selected.classList.contains('status-have')) status = 'have';
          else if (selected.classList.contains('status-partial')) status = 'partial';
          else if (selected.classList.contains('status-need')) status = 'need';
          
          responses.push({
            question: title,
            status: status,
            text: selected.textContent.trim()
          });
        }
      });
      
      return responses;
    }

    function calculateReadinessScore(responses) {
      let score = 0;
      responses.forEach(response => {
        if (response.status === 'have') score += 2;
        else if (response.status === 'partial') score += 1;
      });
      const maxScore = responses.length * 2;
      return Math.round((score / maxScore) * 100);
    }

    function generateResults() {
      if (!validateInputs()) return;
      
      const responses = collectComplianceResponses();
      if (responses.length === 0) {
        alert('Bitte beantworten Sie mindestens eine Frage im Compliance-Check!');
        return;
      }
      
      // Calculate readiness score
      const percentage = calculateReadinessScore(responses);
      
      // Get products for cost calculation
      const products = getAllProducts();
      
      // Generate results
      const resultsContent = generateResultsContent(percentage, responses, products);
      document.getElementById('results-content').innerHTML = resultsContent;
      document.getElementById('results').style.display = 'block';
      
      // Scroll to results first
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    function generateResultsContent(percentage, responses, products) {
      const companyName = document.getElementById('company-name').value;
      
      let readinessLevel = 'Niedrig';
      let readinessColor = '#e74c3c';
      if (percentage >= 70) {
        readinessLevel = 'Hoch';
        readinessColor = '#27ae60';
      } else if (percentage >= 40) {
        readinessLevel = 'Mittel';
        readinessColor = '#f39c12';
      }
      
      let content = `
        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin-bottom:20px;">
          <h3>📊 CBAM-Compliance-Zusammenfassung</h3>
          <p><strong>Unternehmen:</strong> ${companyName}</p>
          <p><strong>Anzahl CBAM-Produkte:</strong> ${products.length}</p>
          <p><strong>Compliance-Bereitschaftsgrad:</strong> <span style="color:${readinessColor}; font-weight:bold;">${percentage}% - ${readinessLevel}</span></p>
        </div>
      `;
      
      // Priority actions based on compliance gaps
      const needActions = responses.filter(r => r.status === 'need');
      const partialActions = responses.filter(r => r.status === 'partial');
      
      if (needActions.length > 0) {
        content += `
          <div class="action-item priority-high">
            <h4>🚨 Kritische Compliance-Lücken</h4>
            <ul style="margin:10px 0; line-height:1.8;">`;
        needActions.forEach(action => {
          content += `<li>${action.question.replace(/^\d+\.\s*/, '')}</li>`;
        });
        content += `</ul>
            <p><strong>Dringlichkeit:</strong> Diese Bereiche müssen vor Januar 2026 vollständig implementiert werden.</p>
          </div>`;
      }
      
      if (partialActions.length > 0) {
        content += `
          <div class="action-item priority-medium">
            <h4>⚠ Verbesserungsbereiche</h4>
            <ul style="margin:10px 0; line-height:1.8;">`;
        partialActions.forEach(action => {
          content += `<li>${action.question.replace(/^\d+\.\s*/, '')}</li>`;
        });
        content += `</ul>
            <p><strong>Empfehlung:</strong> Vollständige Implementierung bis Q3 2025 für optimale Vorbereitung.</p>
          </div>`;
      }
      
      // Cost summary if products are defined
      if (products.length > 0) {
        const totalTonnage = products.reduce((sum, p) => sum + p.tonnage, 0);
        const costs = {};
        Object.keys(ralepaPrices).forEach(year => {
          costs[year] = products.reduce((sum, product) => {
            return sum + calculateCBAMCost(product.tonnage, product.emissions, product.benchmark, ralepaPrices[year], parseInt(year));
          }, 0);
        });
        
        content += `
          <div class="action-item">
            <h4>💰 CBAM-Kostenschätzung (mit CN-Code Daten)</h4>
            <p><strong>Gesamttonnage:</strong> ${totalTonnage.toLocaleString()} t/Jahr</p>
            <p><strong>2026:</strong> €${Math.round(costs[2026]).toLocaleString()} (mit 97,5% Phase-in)</p>
            <p><strong>2030:</strong> €${Math.round(costs[2030]).toLocaleString()}</p>
            <p><strong>2034:</strong> €${Math.round(costs[2034]).toLocaleString()}</p>
            <p style="margin-top:10px; color:#ffeb3b; font-weight:bold;">
              📈 Kostensteigerung 2026-2034: +${Math.round(((costs[2034] - costs[2026]) / costs[2026]) * 100)}%
            </p>
            <div style="background:rgba(255,193,7,0.2); padding:10px; border-radius:5px; margin-top:10px;">
              <small><strong>Hinweis:</strong> Berechnungen berücksichtigen EU-Benchmarks und CBAM Phase-in. Für CN-Codes mit Benchmarks werden diese abgezogen. Für genauere Kalkulationen mit Ihren realen Lieferantendaten kontaktieren Sie Entrenovu.</small>
            </div>
          </div>
        `;
      }
      
      // Next steps
      content += `
        <div class="action-item priority-low">
          <h4>▶ Empfohlene nächste Schritte</h4>
          <ol style="margin:10px 0; line-height:1.8;">
            <li><strong>Sofort:</strong> CBAM-Deklarant-Autorisierung beantragen (ab März 2025)</li>
            <li><strong>Q1 2025:</strong> Lieferanten-Engagement-Programm starten</li>
            <li><strong>Q2 2025:</strong> Interne CBAM-Prozesse und IT-Systeme implementieren</li>
            <li><strong>Q3 2025:</strong> Pilotprojekt mit Verifizierer durchführen</li>
            <li><strong>Q4 2025:</strong> Vollständige Testläufe und Budgetplanung für 2026</li>
            <li><strong>Oktober 2025:</strong> EU-Kommission finale Daten überprüfen und Tool aktualisieren</li>
            <li><strong>Laufend:</strong> CN-Code spezifische Emissionsdaten von Lieferanten sammeln</li>
          </ol>
          <p style="margin-top:15px;"><strong>📞 Expertenunterstützung:</strong> info@entrenovu.com</p>
        </div>
      `;
      
      return content;
    }

    function submitToGoogleSheets() {
      if (!validateInputs()) return;
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '⏳ Wird gesendet...';
      
      // Collect all data
      const responses = collectComplianceResponses();
      const score = calculateReadinessScore(responses);
      const products = getAllProducts();
      const totalImportVolume = products.reduce((sum, p) => sum + p.tonnage, 0);
      
      // Calculate costs with new formula
      const costs2026 = products.reduce((sum, product) => {
        return sum + calculateCBAMCost(product.tonnage, product.emissions, product.benchmark, ralepaPrices[2026], 2026);
      }, 0);
      
      const companyData = {
        timestamp: new Date().toISOString(),
        companyName: document.getElementById('company-name').value,
        contactName: document.getElementById('contact-name').value,
        email: document.getElementById('contact-email').value,
        suppliers: document.getElementById('eu-buyers').value || 'Nicht angegeben',
        companySize: document.getElementById('company-size').value || 'Nicht angegeben',
        readinessScore: score,
        readinessLevel: score >= 70 ? 'Hoch' : score >= 40 ? 'Mittel' : 'Niedrig',
        totalImportVolume: totalImportVolume,
        numberOfProducts: products.length,
        estimatedCosts2026: Math.round(costs2026),
        products: JSON.stringify(products),
        responses: JSON.stringify(responses),
        country: 'Austria/Germany',
        language: 'German',
        calculationType: 'CN-Code Based Multi-Product Analysis',
        calculationMethod: 'Benchmark Formula with CBAM Phase-in'
      };
      
      console.log('Zu sendende Daten:', companyData);
      
      // Your Google Apps Script URL
      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-VhRv-7oPC2b3HImELFmd_nYY6IZ6Eo8H3IWfpmIf88Z6CAY6RkFF9uZL5fBt7qkMlg/exec';

      // Make the request to Google Apps Script
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(companyData)
      })
      .then(() => {
        submitBtn.textContent = '✅ Erfolgreich gesendet!';
        submitBtn.style.background = '#27ae60';

        alert(`✅ Analyse erfolgreich gesendet!\n\n📊 Ihre Ergebnisse:\n- Compliance-Bereitschaft: ${score}%\n- Anzahl Produkte: ${products.length}\n- Gesamtvolumen: ${totalImportVolume.toLocaleString()} t/Jahr\n- Geschätzte CBAM-Kosten 2026: €${Math.round(costs2026).toLocaleString()}\n\nEin Experte von Entrenovu wird Sie innerhalb von 24 Stunden für eine kostenlose Beratung kontaktieren.`);

        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = '✉️ Ergebnisse senden & kostenlose Beratung anfordern';
          submitBtn.style.background = '#060496';
        }, 3000);
      })
      .catch(error => {
        console.error('Fehler beim Senden der Daten:', error);
        submitBtn.textContent = '❌ Sendung fehlgeschlagen';
        submitBtn.style.background = '#e74c3c';

        alert('Es ist ein Fehler beim Senden aufgetreten. Bitte versuchen Sie es erneut.');

        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.textContent = '✉️ Ergebnisse senden & kostenlose Beratung anfordern';
          submitBtn.style.background = '#060496';
        }, 3000);
      });
    }

    // Initialize with one product on load
    window.addEventListener('load', function() {
      addProduct();
    });
  </script>
</body>
</html>
