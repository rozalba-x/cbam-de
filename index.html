<!DOCTYPE html>
<html lang="de-AT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CBAM Schnellrechner</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --accent:#ef4444;
      --bord:#e5e7eb;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .title{font-size:28px;font-weight:700;margin:0 0 8px}
    .subtitle{color:var(--muted);margin:0 0 24px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{
      background:var(--card); border:1px solid var(--bord); border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(2,6,23,.06);
    }
    .card h3{
      margin:0; padding:18px 20px; border-bottom:1px solid var(--bord); font-size:18px;
      display:flex; align-items:center; gap:10px;
    }
    .card-body{padding:20px}
    .row{margin-bottom:16px}
    .label{font-weight:600;margin-bottom:8px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    input[type="text"],input[type="number"]{
      width:100%; border:1px solid var(--bord); background:#fff; border-radius:10px; padding:12px 14px;
      font-size:14px; outline:none;
    }
    .toggle{
      display:inline-flex; align-items:center; gap:12px; background:#f8fafc; border:1px solid var(--bord);
      padding:10px 14px; border-radius:12px;
    }
    .switch{position:relative; width:48px; height:26px; background:#e5e7eb; border-radius:999px; cursor:pointer}
    .switch input{display:none}
    .knob{position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%;
          transition:all .2s ease; border:1px solid var(--bord)}
    .switch input:checked + .knob{left:25px; background:#34d399; border-color:#10b981}
    .inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:none; border-radius:12px; padding:12px 16px; cursor:pointer; font-weight:600; font-size:14px;
      transition:.15s ease; display:inline-flex; align-items:center; gap:8px;
    }
    .btn.primary{background:var(--accent); color:#fff}
    .btn.ghost{background:#f3f4f6; color:#111827}
    .btn:active{transform:translateY(1px)}
    .actions{display:flex; gap:12px; margin-top:8px}
    .result-empty{
      color:var(--muted); text-align:center; padding:48px 16px; display:flex; gap:16px; flex-direction:column; align-items:center;
    }
    .pill{display:inline-block; padding:4px 10px; border:1px solid var(--bord); border-radius:999px; font-size:12px; color:var(--muted)}
    .totals{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:16px}
    .kpi{background:#f8fafc; border:1px solid var(--bord); border-radius:12px; padding:12px}
    .kpi label{display:block; font-size:12px; color:var(--muted)}
    .kpi strong{font-size:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">CBAM Schnellrechner</h1>
    <p class="subtitle">Importdaten eingeben â†’ saubere KostenaufschlÃ¼sselung (Material, Transport, CBAM). Keine externen Anzeigen, keine DatenÃ¼bermittlung.</p>

    <div class="grid">
      <!-- LINKS: EINGABEN -->
      <div class="card">
        <h3>ðŸ“¦ Importdetails</h3>
        <div class="card-body">

          <div class="row">
            <div class="label">Lieferantentyp</div>
            <div class="toggle inline">
              <span>Drittland-Lieferant</span>
              <label class="switch">
                <input id="euToggle" type="checkbox" aria-label="EU-Lieferant umschalten">
                <span class="knob"></span>
              </label>
              <span>EU-Lieferant</span>
              <span class="pill">CBAM gilt nur fÃ¼r Nicht-EU</span>
            </div>
          </div>

          <div class="row">
            <div class="label">Warennummer (KN-Code)</div>
            <input id="cnCode" type="text" placeholder="z. B. 72072000" inputmode="numeric" />
            <div class="hint">FÃ¼r Standard-Emissionswerte (Demo-Satz) zur Auto-BefÃ¼llung.</div>
          </div>

          <div class="row">
            <div class="label">Tonnage</div>
            <input id="tonnage" type="number" min="0" step="0.01" placeholder="Tonnage eingeben" />
          </div>

          <div class="row">
            <div class="label">Lieferantenname</div>
            <input id="supplier" type="text" placeholder="Name des Lieferanten" />
          </div>

          <div class="row inline" style="align-items:flex-end">
            <div style="flex:1">
              <div class="label">EmissionsintensitÃ¤t des Lieferanten (tCOâ‚‚e/Tonne)</div>
              <input id="intensity" type="number" min="0" step="0.01" placeholder="EmissionsintensitÃ¤t eingeben" />
              <div class="hint">Oder â€žStandard nutzenâ€œ klicken, um aus KN-Code zu befÃ¼llen (Demo).</div>
            </div>
            <button id="btnDefault" class="btn ghost">Standard nutzen</button>
          </div>

          <div class="row">
            <div class="label">Materialkosten (â‚¬/Tonne)</div>
            <input id="matCost" type="number" min="0" step="0.01" placeholder="Materialkosten je Tonne" />
          </div>

          <div class="row">
            <div class="label">Transportkosten (â‚¬/Tonne)</div>
            <input id="transCost" type="number" min="0" step="0.01" placeholder="Transportkosten je Tonne" />
          </div>

          <div class="actions">
            <button id="calcBtn" class="btn primary">ðŸ§® CBAM berechnen</button>
            <button id="resetBtn" class="btn ghost">ZurÃ¼cksetzen</button>
          </div>

        </div>
      </div>

      <!-- RECHTS: ERGEBNIS -->
      <div class="card">
        <h3>ðŸ“ˆ Ergebnis</h3>
        <div class="card-body" id="resultsBox">
          <div id="emptyState" class="result-empty">
            <svg width="56" height="56" viewBox="0 0 24 24" fill="none"><path d="M3 19h18M7 19V5h10v14M9 9h6M9 13h6" stroke="#9ca3af" stroke-width="1.5" stroke-linecap="round"/></svg>
            <div><strong>Bereit zur Berechnung</strong></div>
            <div>Daten eingeben, um CBAM-Anforderungen zu kalkulieren</div>
          </div>

          <canvas id="costChart" style="display:none;max-height:360px"></canvas>

          <div id="kpis" class="totals" style="display:none">
            <div class="kpi">
              <label>CBAM-Kosten (â‚¬/t)</label>
              <strong id="kpiCbamPt">0</strong>
            </div>
            <div class="kpi">
              <label>Gesamt (â‚¬/t)</label>
              <strong id="kpiLandedPt">0</strong>
            </div>
            <div class="kpi">
              <label>Auftragssumme (alle t)</label>
              <strong id="kpiTotalAll">0</strong>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------------------
    // Interne Konstanten (nicht in der UI sichtbar)
    // -----------------------------------------

    // RALEPA-basiertes EUA-Preisprofil (â‚¬/tCO2e) â€“ Jahre 2026â€“2034.
    // (Wird intern verwendet; keine Anzeige/Manuelle Steuerung in der UI.)
    // Hinweis: Falls Jahr auÃŸerhalb, wird auf Randjahr begrenzt.
    const RALEPA_EUA_PREIS = {
      2026: 120,
      2027: 126,
      2028: 132,
      2029: 138,
      2030: 146,
      2031: 154,
      2032: 162,
      2033: 171,
      2034: 180
    };

    // CBAM-Phasenfaktor (Anteil der eingebetteten Emissionen, der tatsÃ¤chlich zu bepreisen ist)
    // â€“ interne AnnÃ¤herung, konsistent Ã¼ber die Jahre. Keine Anzeige in der UI.
    const CBAM_FAKTOR = {
      2026: 0.20,
      2027: 0.35,
      2028: 0.45,
      2029: 0.53,
      2030: 0.60,
      2031: 0.75,
      2032: 0.88,
      2033: 0.95,
      2034: 1.00
    };

    function aktuellesJahrBegrenzt(){
      const y = new Date().getFullYear();
      if (y < 2026) return 2026;
      if (y > 2034) return 2034;
      return y;
    }
    function euaPreis() {
      return RALEPA_EUA_PREIS[aktuellesJahrBegrenzt()] || 120;
    }
    function cbamFaktor() {
      return CBAM_FAKTOR[aktuellesJahrBegrenzt()] || 1;
    }

    // Minimaler KNâ†’Default-Satz (tCO2e/t) â€“ Demo-Lookups fÃ¼r Auto-BefÃ¼llung
    const DEFAULTS = [
      { pattern: /^720[0-9]{5}$/, label: "Stahl (generisch)", value: 2.20 },
      { pattern: /^7604/,         label: "Aluminium StÃ¤be/DrÃ¤hte (7604)", value: 9.80 },
      { pattern: /^7606/,         label: "Aluminium Bleche/Platten (7606)", value: 12.11 },
      { pattern: /^25232900$/,    label: "Portlandzement (2523 29 00)", value: 0.87 },
      { pattern: /^25232100$/,    label: "WeiÃŸzement (2523 21 00)", value: 1.26 },
      { pattern: /^310210/,       label: "Harnstoff/Urea (3102 10)", value: 1.90 },
      { pattern: /^281410/,       label: "Ammoniak (2814 10)", value: 2.82 }
    ];
    function lookupDefaultIntensity(cn){
      if(!cn) return null;
      const code = String(cn).replace(/\s|\.|-/g,'').trim();
      for(const row of DEFAULTS){ if(row.pattern.test(code)) return { value: row.value, label: row.label }; }
      if(/^76/.test(code)) return { value: 10.5, label: "Aluminium (generisch)" };
      if(/^72/.test(code) || /^73/.test(code)) return { value: 2.3, label: "Stahl (generisch)" };
      if(/^2523/.test(code)) return { value: 0.9, label: "Zement (generisch)" };
      if(/^31/.test(code))   return { value: 2.2, label: "DÃ¼nger (generisch)" };
      return null;
    }

    // -----------------------------------------
    // DOM-Helfer
    // -----------------------------------------
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=> isFinite(n) ? Number(n).toLocaleString('de-AT',{maximumFractionDigits:2}) : 'â€“';

    $('btnDefault').addEventListener('click', (e)=>{
      e.preventDefault();
      const hit = lookupDefaultIntensity($('cnCode').value);
      if(hit){
        $('intensity').value = hit.value;
        $('intensity').dataset.source = hit.label;
      }else{
        alert('Kein Standardwert fÃ¼r diesen KN-Code gefunden.\nBitte EmissionsintensitÃ¤t manuell eingeben.');
      }
    });

    $('resetBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      ['cnCode','tonnage','supplier','intensity','matCost','transCost'].forEach(id=>{$(id).value='';});
      $('euToggle').checked = false;
      destroyChart();
      showEmpty();
    });

    $('calcBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      calculate();
    });

    // -----------------------------------------
    // Kernberechnung & Chart
    // -----------------------------------------
    let chart;

    function calculate(){
      const istEU = $('euToggle').checked;           // EU-Lieferant â†’ CBAM = 0
      const tonnage = +($('tonnage').value || 0);
      const intens  = +($('intensity').value || 0);
      const mat     = +($('matCost').value || 0);
      const trans   = +($('transCost').value || 0);

      if(tonnage<=0 || mat<0 || trans<0){
        return alert('Bitte gÃ¼ltige Tonnage sowie Material-/Transportkosten eingeben.');
      }
      if(!istEU && intens<=0){
        return alert('Bitte EmissionsintensitÃ¤t (tCOâ‚‚e/t) eingeben oder â€žStandard nutzenâ€œ verwenden.');
      }

      // Verdeckte Preislogik: RALEPA EUA-Preis Ã— CBAM-Phasenfaktor Ã— IntensitÃ¤t
      const preis = euaPreis();
      const faktor = cbamFaktor();
      const cbam_pro_t = istEU ? 0 : (intens * preis * faktor);
      const gesamt_pro_t = mat + trans + cbam_pro_t;
      const auftragssumme = gesamt_pro_t * tonnage;

      renderChart({mat, trans, cbam: cbam_pro_t});
      updateKPIs({cbam_pro_t, gesamt_pro_t, auftragssumme});
    }

    function updateKPIs({cbam_pro_t, gesamt_pro_t, auftragssumme}){
      $('kpiCbamPt').textContent   = fmt(cbam_pro_t);
      $('kpiLandedPt').textContent = fmt(gesamt_pro_t);
      $('kpiTotalAll').textContent = fmt(auftragssumme);
      $('kpis').style.display = 'grid';
    }

    function showEmpty(){
      $('emptyState').style.display = 'flex';
      $('costChart').style.display = 'none';
      $('kpis').style.display = 'none';
    }

    function destroyChart(){
      if(chart){ chart.destroy(); chart=null; }
    }

    function renderChart({mat, trans, cbam}){
      $('emptyState').style.display = 'none';
      const ctx = $('costChart');
      ctx.style.display = 'block';

      destroyChart();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['â‚¬/Tonne â€“ AufschlÃ¼sselung'],
          datasets: [
            {label:'Material',  data:[mat]},
            {label:'Transport', data:[trans]},
            {label:'CBAM',      data:[cbam]}
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins: {
            legend:{ position:'top' },
            tooltip:{ callbacks:{
              label:(c)=> `${c.dataset.label}: â‚¬${fmt(c.parsed.y)}`
            }},
            title:{ display:true, text:'Gesamtkosten je Tonne (â‚¬/t)' }
          },
          scales: {
            y: { beginAtZero:true, ticks:{ callback:(v)=>'â‚¬'+fmt(v) } }
          }
        }
      });
    }
  </script>
</body>
</html>
