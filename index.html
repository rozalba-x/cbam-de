<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBAM Gap-Analyse Template</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Poppins', sans-serif; line-height:1.6; background:white; min-height:100vh; color:#000; }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    .header { background:white; border-radius:15px; padding:30px; text-align:center; margin-bottom:30px; box-shadow:0 10px 30px rgba(6,4,150,0.1); border:2px solid #060496; }
    .header h1 { color:#060496; font-size:2.5em; margin-bottom:10px; font-weight:700; }
    .deadline-notice{ background:#060496; color:white; padding:15px; border-radius:10px; margin:20px 0; text-align:center; font-weight:500; font-size:1.0em; }
    .financial-projection{ background:#060496; color:white; padding:25px; border-radius:15px; margin:20px 0; }
    .projection-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin:20px 0; }
    .projection-card{ background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; border-left:5px solid #fff; }
    .sector-selector{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
    .sector-btn{ background:white; border:3px solid #e0e0e0; border-radius:15px; padding:20px; text-align:center; cursor:pointer; transition:all .3s ease; box-shadow:0 5px 15px rgba(0,0,0,.1); }
    .sector-btn:hover, .sector-btn.active{ border-color:#060496; background:#f8f9fa; transform:translateY(-2px); }
    .sector-icon{ font-size:2em; margin-bottom:10px; }
    .gap-analysis{ background:white; border-radius:15px; padding:30px; margin:20px 0; box-shadow:0 10px 30px rgba(6,4,150,0.1); border:2px solid #060496; display:none; }
    .gap-analysis.active{ display:block; }
    .question-block{ background:#f8f9fa; border-left:5px solid #060496; padding:20px; margin:15px 0; border-radius:5px; }
    .question-title{ font-weight:600; color:#000; margin-bottom:10px; font-size:1.1em; }
    .status-grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:15px; }
    .status-option{ padding:10px; border-radius:8px; text-align:center; cursor:pointer; border:2px solid transparent; transition:all .3s ease; }
    .status-have{ background:#d4edda; color:#155724; }
    .status-partial{ background:#fff3cd; color:#856404; }
    .status-need{ background:#f8d7da; color:#721c24; }
    .status-option:hover, .status-option.selected{ border-color:#060496; transform:scale(1.02); }
    .company-info{ background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px; border:2px solid #060496; }
    .info-row{ display:grid; grid-template-columns:200px 1fr; gap:15px; margin:10px 0; align-items:center; }
    .info-label{ font-weight:600; color:#000; }
    .info-input{ padding:8px 12px; border:2px solid #060496; border-radius:5px; font-size:14px; }
    .info-input:focus{ outline:none; border-color:#060496; box-shadow:0 0 0 3px rgba(6,4,150,0.1); }
    .required{ color:#e74c3c; }
    .results-section{ background:#060496; color:white; padding:25px; border-radius:15px; margin-top:30px; }
    .action-item{ background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; margin:10px 0; border-left:4px solid #fff; }
    .generate-btn{ background:#060496; color:white; border:none; padding:15px 30px; border-radius:10px; font-size:1.1em; cursor:pointer; margin:20px auto; display:block; transition:all .3s ease; font-weight:600; }
    .generate-btn:hover{ background:#050385; transform:scale(1.05); }
    .austria-germany-info{ background:#060496; color:white; padding:25px; border-radius:15px; margin:20px 0; }
    .validation-error{ border-color:#e74c3c !important; }
    .error-message{ color:#e74c3c; font-size:12px; margin-top:5px; }
    .chart-container{ background:rgba(255,255,255,0.1); padding:25px; border-radius:10px; margin:25px 0; }
    .chart-wrapper{ position:relative; height:400px; background:white; border-radius:8px; padding:15px; }
    #projectionChart{ width:100%!important; height:100%!important; }

    /* Indirect emissions UI */
    .indirect-toggle { background:#e8f0fe; border:2px solid #060496; padding:12px 14px; border-radius:10px; margin:10px 0 15px; display:flex; gap:12px; align-items:flex-start; opacity:0.5; pointer-events:none; }
    .indirect-info { background:#fff3cd; border:2px solid #856404; color:#333; padding:12px 14px; border-radius:10px; margin:10px 0 20px; }
    .muted { color:#666; font-size:0.9em; }
    
    .product-item { background:white; border:2px solid #060496; border-radius:8px; padding:15px; margin:10px 0; }
    .cost-calculator-section { background:#f8f9fa; padding:25px; border-radius:15px; margin:20px 0; border:2px solid #060496; }

    @media (max-width:700px){
      .status-grid{ grid-template-columns:1fr; }
      .info-row{ grid-template-columns:1fr; }
      .projection-grid{ grid-template-columns:1fr; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:20px;">
        <svg width="160" height="48" viewBox="0 0 320 96" style="flex-shrink:0;">
          <text x="0" y="65" font-family="Poppins, sans-serif" font-size="38" font-weight="400" fill="#060496">entrenovu.</text>
        </svg>
        <div style="text-align:right;">
          <div style="font-size:12px; color:#666; margin-bottom:5px;">
            Powered by <a href="https://www.entrenovu.com/" target="_blank" style="color:#060496; text-decoration:none; font-weight:500;">entrenovu</a>
          </div>
        </div>
      </div>
      <h1>CBAM Gap-Analyse</h1>
      <p>Für österreichische und deutsche Importeure</p>
    </div>

    <div class="deadline-notice">
      CBAM-Vollphase startet am 1. Januar 2026. Nutzen Sie diese Zeit zur systematischen Vorbereitung.
    </div>

    <!-- CBAM Cost Calculator -->
    <div class="cost-calculator-section">
      <h2 style="color:#060496; margin-bottom:20px; font-weight:600;">CBAM-Kostenschätzer</h2>
      <p style="color:#666; margin-bottom:25px; font-weight:400;">Erhalten Sie eine erste Orientierung über potenzielle CBAM-Kosten. Füllen Sie das Formular aus und klicken Sie auf "Kosten berechnen".</p>
      
      <!-- Company info - REQUIRED FOR CALCULATIONS -->
      <div class="company-info" style="margin-bottom:25px;">
        <h3 style="margin-bottom:15px; color:#000; font-weight:500;">Schritt 1: Unternehmensdaten</h3>
        <div class="info-row">
          <div class="info-label">Firmenname: <span class="required">*</span></div>
          <div>
            <input type="text" class="info-input" id="company-name" placeholder="z.B. Austrian Steel Import GmbH" required>
            <div class="error-message" id="company-name-error"></div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Ihr Name: <span class="required">*</span></div>
          <div>
            <input type="text" class="info-input" id="contact-name" placeholder="z.B. Max Mustermann" required>
            <div class="error-message" id="contact-name-error"></div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">E-Mail: <span class="required">*</span></div>
          <div>
            <input type="email" class="info-input" id="contact-email" placeholder="z.B. max.mustermann@firma.at" required>
            <div class="error-message" id="contact-email-error"></div>
          </div>
        </div>
        <div class="info-row">
          <div class="info-label">Hauptlieferanten (Länder):</div>
          <input type="text" class="info-input" id="eu-buyers" placeholder="z.B. Türkei, Ukraine, Serbien, China">
        </div>
        <div class="info-row">
          <div class="info-label">Unternehmensgröße:</div>
          <select class="info-input" id="company-size">
            <option value="">Bitte wählen...</option>
            <option value="small">Klein (&lt; 50 Mitarbeiter)</option>
            <option value="medium">Mittel (50-250 Mitarbeiter)</option>
            <option value="large">Groß (&gt; 250 Mitarbeiter)</option>
          </select>
        </div>
      </div>

      <!-- Product Data Entry -->
      <div style="background:white; border:2px solid #060496; border-radius:10px; padding:20px; margin-bottom:25px;">
        <h3 style="margin-bottom:15px; color:#060496; font-weight:500;">Schritt 2: CBAM-Produkte</h3>
        
        <!-- Indirect emissions toggle - disabled/beta -->
        <div class="indirect-toggle">
          <input type="checkbox" id="include-indirect" disabled />
          <div>
            <strong>Indirekte Emissionen berücksichtigen <span style="background:#ff6b35; color:white; padding:2px 6px; border-radius:3px; font-size:0.8em; margin-left:8px;">BETA</span></strong><br/>
            <span class="muted">Wird bald als Option verfügbar sein.</span>
          </div>
        </div>
        <div class="indirect-info">
          <strong>Indirekte Emissionen (Scope 2)</strong>
          <p style="margin-top:6px;">Entstehen durch Stromverbrauch bei der Herstellung. Abhängig vom Strommix des Herstellungslandes bzw. anlagenspezifischen Daten.</p>
        </div>

        <div id="product-calculator">
          <div id="products-container"></div>
          <button type="button" onclick="addProduct()" style="background:#060496; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin:10px 0;">Produkt hinzufügen</button>
        </div>
      </div>

      <!-- Calculate Button -->
      <div style="text-align:center; margin:25px 0;">
        <button onclick="calculateCBAMCosts()" style="background:#060496; color:white; border:none; padding:15px 40px; border-radius:10px; font-size:1.2em; cursor:pointer; font-weight:600; font-family:'Poppins', sans-serif;">
          CBAM-Kosten berechnen
        </button>
        <p style="color:#666; font-size:0.9em; margin-top:10px;">Ihre Daten werden zur Analyse gespeichert</p>
      </div>

      <!-- Results Section -->
      <div id="cost-summary" style="display:none; background:#060496; color:white; padding:25px; border-radius:15px; margin-top:25px;">
        <h3 style="margin-bottom:20px;">Ihre CBAM-Kostenschätzung</h3>
        <div id="total-costs-content"></div>
        <div class="chart-container" id="cost-chart-container" style="display:none; margin-top:20px;">
          <div class="chart-wrapper">
            <canvas id="costProjectionChart"></canvas>
          </div>
          <div style="margin-top:15px; font-size:0.9em; text-align:center; color:#ddd;">
            <p>Hinweis: Die Grafik zeigt prognostizierte CBAM-Kosten basierend auf konservativen Marktprognosen</p>
          </div>
        </div>
        
        <!-- Cost disclaimer and CTA -->
        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:8px; margin-top:20px;">
          <p style="font-size:0.9em; margin-bottom:20px;"><strong>Kostenschätzung:</strong> Diese Kostenschätzungen basieren auf EU-Übergangsdaten und CN-Code spezifischen Emissionswerten. Es handelt sich um grobe Orientierungswerte - die tatsächlichen Kosten hängen von komplexen, unternehmens- und lieferantenspezifischen Faktoren ab.</p>
          
          <div style="text-align:center; padding:20px; background:#ffffff; border-radius:10px;">
            <h4 style="color:#060496; margin-bottom:15px; font-weight:600;">Präzise CBAM-Analyse für Ihr Unternehmen</h4>
            <p style="color:#333; margin-bottom:15px; font-weight:400;">Die Komplexität von CBAM erfordert spezialisierte Beratung für eine erfolgreiche und kostenoptimierte Implementierung.</p>
            <a href="mailto:info@entrenovu.com?subject=CBAM-Beratungsanfrage&body=Sehr geehrte Damen und Herren,%0D%0A%0D%0AIch interessiere mich für eine professionelle CBAM-Beratung und Implementierungsbegleitung.%0D%0A%0D%0AMit freundlichen Grüßen" 
               style="background:#060496; color:white; padding:12px 25px; border-radius:8px; text-decoration:none; font-weight:600; display:inline-block;">
              Professionelle Beratung anfragen
            </a>
          </div>
        </div>
      </div>
    </div>

    <div style="background:linear-gradient(135deg, #060496 0%, #4338ca 100%); color:white; padding:30px; border-radius:20px; margin:25px 0; box-shadow:0 10px 30px rgba(6,4,150,0.2);">
      <h2 style="margin-bottom:20px; font-weight:600;">CBAM-Kostenprognose</h2>
      <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:15px; backdrop-filter:blur(10px);">
        <div class="projection-grid">
          <div class="projection-card" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.2);">
            <h4 style="font-weight:500; color:#ffffff;">Kostenfaktoren mit hoher Komplexität</h4>
            <p style="font-weight:400; color:#f1f5f9;">Die tatsächlichen CBAM-Kosten sind deutlich komplexer als einfache Schätzungen und hängen von zahlreichen interdependenten Faktoren ab:</p>
            <ul style="line-height:1.6; font-weight:400; color:#f1f5f9;">
              <li>Qualität und Vollständigkeit der Lieferantendaten</li>
              <li>Produktspezifische Emissionswerte und Verifizierungsanforderungen</li>
              <li>Anwendbare ETS-Benchmarks und deren zeitliche Entwicklung</li>
              <li>Regulatorische Entwicklungen und Auslegungsunsicherheiten</li>
              <li>Lieferkettenspezifische Scope-2-Emissionen</li>
              <li>Nationale Implementierungsunterschiede</li>
            </ul>
          </div>
          <div class="projection-card" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.2);">
            <h4 style="font-weight:500; color:#ffffff;">Professionelle Begleitung notwendig</h4>
            <p style="font-weight:400; color:#f1f5f9;">CBAM-Compliance erfordert spezialisierte Expertise in Bereichen wie:</p>
            <ul style="line-height:1.6; font-weight:400; color:#f1f5f9;">
              <li>Technische Emissionsdatenverifizierung</li>
              <li>Rechtliche Compliance-Strukturen</li>
              <li>IT-Systemintegration für Datenmanagement</li>
              <li>Lieferanten-Engagement und Vertragsgestaltung</li>
              <li>Risikomanagement und Kostenoptimierung</li>
              <li>Audit-Bereitschaft und Verifizierungsprozesse</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="austria-germany-info">
      <h2 style="font-weight:500;">Regulatorische Anforderungen für deutsche und österreichische Importeure</h2>
      <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin:15px 0;">
        <h3 style="font-weight:500;">CBAM-Deklarant-Autorisierung</h3>
        <p style="font-weight:400;">Ab 1. Januar 2026 ist eine Autorisierung als CBAM-Deklarant erforderlich. Anträge können ab März 2025 bei den nationalen Behörden gestellt werden.</p>
      </div>
      <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin:15px 0;">
        <h3 style="font-weight:500;">Hauptverantwortlichkeiten</h3>
        <p style="font-weight:400;">Sammlung von Emissionsdaten der Lieferanten, Quartalsberichterstattung bis Ende 2025, Kauf und Abgabe von CBAM-Zertifikaten ab 2026, unabhängige Verifizierung der Berichte und jährliche Deklaration bis 31. Mai.</p>
      </div>
      <div style="background:rgba(255,255,255,0.2); padding:20px; border-radius:10px; margin:15px 0;">
        <h3 style="font-weight:500;">Schwellenwerte und Sanktionen</h3>
        <p style="font-weight:400;">50-Tonnen-Regel: Importeure unter 50 t/Jahr sind von der Berichtspflicht befreit (ausgenommen Wasserstoff und Elektrizität). Sanktionen: 10-50€ pro Tonne in der Übergangsphase, ab 2026: 100€ pro fehlendes CBAM-Zertifikat.</p>
      </div>
    </div>

    <h3 style="color:#060496; text-align:center; margin:20px 0; font-weight:500;">CBAM-Compliance-Bereitschaftscheck</h3>
    <p style="text-align:center; color:#666; margin-bottom:20px; font-weight:400;">Eine systematische Bewertung Ihrer CBAM-Vorbereitung kann Ihnen dabei helfen, Prioritäten zu setzen und kritische Lücken zu identifizieren.</p>

    <div id="compliance-analysis" class="gap-analysis" style="display:block;">
      <h2 style="color:#060496; margin-bottom:20px; font-weight:600;">CBAM-Compliance-Bereitschaftscheck für Importeure</h2>
      <div class="question-block" data-question="1">
        <div class="question-title">1. CBAM-Deklarant-Autorisierung</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 1, 'have')">Erledigt<br><small>Autorisierung beantragt/erhalten</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 1, 'partial')">In Planung<br><small>Vorbereitung läuft</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 1, 'need')">Noch nicht begonnen<br><small>Keine Maßnahmen eingeleitet</small></div>
        </div>
      </div>
      <div class="question-block" data-question="2">
        <div class="question-title">2. Lieferanten-Datensammlung & -management</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 2, 'have')">Etabliert<br><small>System funktioniert gut</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 2, 'partial')">Teilweise<br><small>Einige Lieferanten kooperieren</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 2, 'need')">Fehlt<br><small>Keine strukturierte Datensammlung</small></div>
        </div>
      </div>
      <div class="question-block" data-question="3">
        <div class="question-title">3. CBAM-Registry & Berichtssystem</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 3, 'have')">Betriebsbereit<br><small>Regelmäßige Berichte abgegeben</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 3, 'partial')">Teilweise<br><small>Zugang vorhanden, Nutzung sporadisch</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 3, 'need')">Nicht vorbereitet<br><small>Kein Zugang oder Training</small></div>
        </div>
      </div>
      <div class="question-block" data-question="4">
        <div class="question-title">4. Interne CBAM-Organisation & Prozesse</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 4, 'have')">Gut organisiert<br><small>Klare Rollen & Prozesse</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 4, 'partial')">In Aufbau<br><small>Teilweise definiert</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 4, 'need')">Fehlend<br><small>Keine klaren Zuständigkeiten</small></div>
        </div>
      </div>
      <div class="question-block" data-question="5">
        <div class="question-title">5. Finanzplanung für CBAM-Zertifikate</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 5, 'have')">Budgetiert<br><small>Finanzierung gesichert</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 5, 'partial')">Geplant<br><small>Schätzungen vorhanden</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 5, 'need')">Ungeplant<br><small>Keine Budgetierung</small></div>
        </div>
      </div>
      <div class="question-block" data-question="6">
        <div class="question-title">6. Verifizierung & Audit-Bereitschaft</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 6, 'have')">Bereit<br><small>Prüfer identifiziert, Systeme auditfähig</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 6, 'partial')">In Vorbereitung<br><small>Teilweise vorbereitet</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 6, 'need')">Nicht bereit<br><small>Keine Vorbereitung</small></div>
        </div>
      </div>
      <div class="question-block" data-question="7">
        <div class="question-title">7. Rechtliche & Compliance-Expertise</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 7, 'have')">Vorhanden<br><small>Experten im Team/extern</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 7, 'partial')">Grundwissen<br><small>Basiskenntnisse vorhanden</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 7, 'need')">Fehlt<br><small>Keine Expertise aufgebaut</small></div>
        </div>
      </div>
      <div class="question-block" data-question="8">
        <div class="question-title">8. IT-Systeme & Datenmanagement</div>
        <div class="status-grid">
          <div class="status-option status-have" onclick="selectStatus(this, 8, 'have')">Integriert<br><small>Systeme funktionieren</small></div>
          <div class="status-option status-partial" onclick="selectStatus(this, 8, 'partial')">Teilweise<br><small>Manuelle Prozesse</small></div>
          <div class="status-option status-need" onclick="selectStatus(this, 8, 'need')">Nicht vorbereitet<br><small>Keine IT-Lösung</small></div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="results" style="display:none;">
      <h2 style="margin-bottom:20px;">Ergebnisse der CBAM Gap-Analyse</h2>
      <div id="results-content"></div>
    </div>

    <button class="generate-btn" onclick="generateResults()">Gap-Analyse erstellen</button>

    <!-- Industry-Specific Content -->
    <div style="background:#f8f9fa; padding:30px; border-radius:15px; margin:30px 0; border:2px solid #060496;">
      <h2 style="color:#060496; margin-bottom:25px; font-weight:600;">Branchen-spezifische CBAM-Auswirkungen</h2>
      
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:25px;">
        <div style="background:white; padding:20px; border-radius:10px; border-left:4px solid #060496;">
          <h3 style="color:#060496; margin-bottom:15px; font-weight:500;">Maschinenbau & Anlagenbau</h3>
          <p style="font-weight:400; margin-bottom:15px;">Der deutsche und österreichische Maschinenbau steht vor erheblichen Herausforderungen durch CBAM, da viele Komponenten aus kostenintensiven CBAM-Materialien bestehen.</p>
          <ul style="line-height:1.6; color:#555; font-weight:400;">
            <li>Stahlkomponenten: Direkte Betroffenheit bei Importen aus Nicht-EU-Ländern</li>
            <li>Aluminiumteile: Besonders hohe CBAM-Kosten durch energieintensive Produktion</li>
            <li>Lieferketten-Komplexität: Nachverfolgung über mehrere Produktionsstufen erforderlich</li>
            <li>Kostenvolatilität: CBAM-Preise werden zu einem neuen Kalkulationsfaktor</li>
          </ul>
        </div>

        <div style="background:white; padding:20px; border-radius:10px; border-left:4px solid #060496;">
          <h3 style="color:#060496; margin-bottom:15px; font-weight:500;">Automotive & Zulieferer</h3>
          <p style="font-weight:400; margin-bottom:15px;">Die Automobilindustrie muss CBAM-Kosten in ihre Just-in-Time-Lieferketten und Kostenkalkulation integrieren.</p>
          <ul style="line-height:1.6; color:#555; font-weight:400;">
            <li>Stahlbleche und -profile: Bedeutende Mengen für Karosseriebau</li>
            <li>Aluminiumkomponenten: Motor-, Getriebe- und Leichtbauteile</li>
            <li>Langfristige Lieferverträge: CBAM-Klauseln werden Standard</li>
            <li>Competitive Sourcing: EU vs. Drittländer-Lieferanten neu bewerten</li>
          </ul>
        </div>

        <div style="background:white; padding:20px; border-radius:10px; border-left:4px solid #060496;">
          <h3 style="color:#060496; margin-bottom:15px; font-weight:500;">Bauwirtschaft & Infrastruktur</h3>
          <p style="font-weight:400; margin-bottom:15px;">Bauunternehmen und Infrastrukturprojekte müssen CBAM-Kosten für Grundmaterialien in Projektkalkulationen einbeziehen.</p>
          <ul style="line-height:1.6; color:#555; font-weight:400;">
            <li>Zement: Direkte Auswirkungen auf Betonkosten</li>
            <li>Baustahl: Große Mengen bei Hochbau- und Infrastrukturprojekten</li>
            <li>Projektlaufzeiten: Mehrjährige Projekte benötigen CBAM-Preisprognosen</li>
            <li>Öffentliche Aufträge: CBAM-Kosten in Ausschreibungen berücksichtigen</li>
          </ul>
        </div>

        <div style="background:white; padding:20px; border-radius:10px; border-left:4px solid #060496;">
          <h3 style="color:#060496; margin-bottom:15px; font-weight:500;">Chemie & Prozessindustrie</h3>
          <p style="font-weight:400; margin-bottom:15px;">Chemieunternehmen sind sowohl als Importeure von CBAM-Gütern als auch als Hersteller komplexer Wertschöpfungsketten betroffen.</p>
          <ul style="line-height:1.6; color:#555; font-weight:400;">
            <li>Düngemittel: Ammoniak, Harnstoff und komplexe NPK-Dünger</li>
            <li>Grundchemikalien: Wasserstoff und weitere chemische Grundstoffe</li>
            <li>Scope-3-Emissionen: CBAM-Kosten fließen in Produktfußabdruck ein</li>
            <li>Prozessoptimierung: Rohstoffwahl wird durch CBAM-Kosten beeinflusst</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Cross-Functional Implementation Section -->
    <div style="background:#060496; color:white; padding:30px; border-radius:15px; margin:30px 0;">
      <h2 style="margin-bottom:25px; font-weight:600;">CBAM-Integration in Unternehmensstrukturen</h2>
      <p style="margin-bottom:20px; font-weight:400;">CBAM betrifft multiple Unternehmensbereiche und erfordert koordinierte Ansätze:</p>
      
      <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:25px;">
        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;">
          <h3 style="margin-bottom:15px; font-weight:500;">Nachhaltigkeitsmanagement</h3>
          <p style="font-weight:400; margin-bottom:15px;">CBAM transformiert CO₂-Intensität zu messbaren Geschäftsfaktoren. Zentrale Aspekte umfassen:</p>
          <ul style="line-height:1.6; font-weight:400;">
            <li>Scope-3-Emissionen als direkte Kostenkomponenten</li>
            <li>Lieferanten-Nachhaltigkeitsbewertungen mit finanzieller Relevanz</li>
            <li>CO₂-Intensität als neues Beschaffungskriterium</li>
            <li>Compliance-relevante Nachhaltigkeitsberichterstattung</li>
          </ul>
          <p style="margin-top:10px; font-style:italic; font-size:0.9em;">Detaillierte Implementierungsstrategien erfordern unternehmensspezifische Beratung.</p>
        </div>

        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;">
          <h3 style="margin-bottom:15px; font-weight:500;">Supply Chain Management</h3>
          <p style="font-weight:400; margin-bottom:15px;">CBAM-Kosten beeinflussen fundamentale Sourcing-Entscheidungen:</p>
          <ul style="line-height:1.6; font-weight:400;">
            <li>Lieferanten-Emissionsdaten als Auswahlkriterium</li>
            <li>CBAM-Kosten in Total Cost of Ownership</li>
            <li>Regionale vs. globale Beschaffungsstrategien</li>
            <li>Langfristige Verträge mit CBAM-Preisklauseln</li>
          </ul>
          <p style="margin-top:10px; font-style:italic; font-size:0.9em;">Strategische Sourcing-Optimierung benötigt spezialisierte Expertise.</p>
        </div>

        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;">
          <h3 style="margin-bottom:15px; font-weight:500;">Finanzwesen & Controlling</h3>
          <p style="font-weight:400; margin-bottom:15px;">CBAM schafft neue finanzielle Komplexitäten:</p>
          <ul style="line-height:1.6; font-weight:400;">
            <li>CBAM-Kosten in Budgetplanung und Forecasting</li>
            <li>CO₂-Preisvolatilität als neues Marktrisiko</li>
            <li>Produktkalkulation mit CO₂-Kostenkomponenten</li>
            <li>Working Capital für CBAM-Zertifikatskäufe</li>
          </ul>
          <p style="margin-top:10px; font-style:italic; font-size:0.9em;">Risikomanagement und Hedging-Strategien erfordern professionelle Entwicklung.</p>
        </div>
      </div>

      <div style="background:rgba(255,255,255,0.2); padding:20px; border-radius:10px; margin-top:25px; text-align:center;">
        <h3 style="margin-bottom:15px; font-weight:500;">Koordinierte Implementierung notwendig</h3>
        <p style="font-weight:400; font-size:1.1em;">CBAM-Compliance erfordert die Koordination multipler Unternehmensbereiche mit spezialisierten Kenntnissen in Regulatorik, Technik und Operations. Die Komplexität der interdependenten Faktoren macht professionelle Implementierungsbegleitung für eine erfolgreiche und kostenoptimierte Umsetzung unerlässlich.</p>
      </div>
    </div>

    <!-- Final CTA Box -->
    <div style="background:#f8f9fa; border:2px solid #060496; padding:25px; border-radius:15px; margin:30px 0; text-align:center;">
      <h3 style="color:#060496; margin-bottom:20px; font-weight:600;">Sind Sie bereit für eine professionelle CBAM-Begleitung?</h3>
      <p style="color:#333; margin-bottom:20px; font-weight:400;">Von der Kostenschätzung zur vollständigen CBAM-Compliance - entwickeln Sie mit uns Ihre maßgeschneiderte Implementierungsstrategie.</p>
      
      <a href="mailto:info@entrenovu.com?subject=CBAM-Komplettberatung&body=Sehr geehrte Damen und Herren,%0D%0A%0D%0AIch interessiere mich für eine umfassende CBAM-Beratung und Implementierungsbegleitung.%0D%0A%0D%0AMit freundlichen Grüßen" 
         style="background:#060496; color:white; padding:15px 40px; border-radius:8px; text-decoration:none; font-weight:600; display:inline-block; margin-top:15px; font-size:1.1em;">
        Vollständige CBAM-Beratung: info@entrenovu.com
      </a>
    </div>
  </div>

  <script>
    let projectionChart = null;
    let costProjectionChart = null;
    let productCounter = 0;
    let includeIndirect = false;
    let analysisAnswers = {};

    const co2Prices = { 2026:90, 2027:95, 2028:108, 2029:120, 2030:138, 2031:148, 2032:158, 2033:168, 2034:178 };
    const cbamPhaseIn = { 2026:0.975, 2027:1.0, 2028:1.0, 2029:1.0, 2030:1.0, 2031:1.0, 2032:1.0, 2033:1.0, 2034:1.0 };

    const ETS_BM = {
      clinker_grey: 0.693, clinker_white: 0.957, hot_metal: 1.288, eaf_carbon_steel: 0.215, eaf_high_alloy_steel: 0.268,
      primary_aluminium: 1.464, ammonia: 1.570, nitric_acid: 0.230, hydrogen: 6.84
    };

    const cnCodeDatabaseRaw = {
      // CEMENT
      "2507 00 80": { sector:"Cement", product:"Other kaolinic clays (calcined clay only; non-calcined=0)", direct:0.23, indirect:0.08, total:0.32, benchmark:null },
      "2523 10 00": { sector:"Cement", product:"Cement clinkers (grey)", direct:0.83, indirect:0.04, total:0.87, benchmark:ETS_BM.clinker_grey },
      "2523 21 00": { sector:"Cement", product:"White Portland cement", direct:1.16, indirect:0.10, total:1.26, benchmark:ETS_BM.clinker_white },
      "2523 29 00": { sector:"Cement", product:"Other Portland cement", direct:0.81, indirect:0.06, total:0.87, benchmark:ETS_BM.clinker_grey },
      "2523 90 00": { sector:"Cement", product:"Other hydraulic cements", direct:0.59, indirect:0.04, total:0.63, benchmark:ETS_BM.clinker_grey },
      "2523 30 00": { sector:"Cement", product:"Aluminous cement", direct:1.75, indirect:0.15, total:1.90, benchmark:null },
      // FERTILISERS
      "2808 00 00": { sector:"Fertilisers", product:"Nitric acid", direct:2.56, indirect:0.05, total:2.60, benchmark:ETS_BM.nitric_acid },
      "2814": { sector:"Fertilisers", product:"Ammonia", direct:2.68, indirect:0.14, total:2.82, benchmark:ETS_BM.ammonia },
      "2834 21 00": { sector:"Fertilisers", product:"Nitrates of potassium", direct:1.82, indirect:0.06, total:1.88, benchmark:null },
      "3102 10": { sector:"Fertilisers", product:"Urea", direct:1.78, indirect:0.12, total:1.90, benchmark:ETS_BM.ammonia },
      "3102 21 00": { sector:"Fertilisers", product:"Ammonium sulphate", direct:0.86, indirect:0.09, total:0.94, benchmark:ETS_BM.ammonia },
      "3102 29 00": { sector:"Fertilisers", product:"Double salts (AS & AN)", direct:1.54, indirect:0.10, total:1.63, benchmark:ETS_BM.ammonia },
      "3102 30": { sector:"Fertilisers", product:"Ammonium nitrate", direct:2.32, indirect:0.07, total:2.39, benchmark:ETS_BM.ammonia },
      "3102 40": { sector:"Fertilisers", product:"CAN", direct:1.77, indirect:0.06, total:1.84, benchmark:ETS_BM.ammonia },
      "3102 50 00": { sector:"Fertilisers", product:"Sodium nitrate", direct:3.99, indirect:0.07, total:4.06, benchmark:null },
      "3102 60 00": { sector:"Fertilisers", product:"Calcium nitrate + AN", direct:1.87, indirect:0.08, total:1.95, benchmark:ETS_BM.ammonia },
      "3102 80 00": { sector:"Fertilisers", product:"UAN", direct:1.28, indirect:0.06, total:1.34, benchmark:ETS_BM.ammonia },
      "3102 90 00": { sector:"Fertilisers", product:"Other nitrogen fertilisers", direct:1.65, indirect:0.10, total:1.74, benchmark:ETS_BM.ammonia },
      "3105 10 00": { sector:"Fertilisers", product:"Tablets/similar ≤10kg", direct:0.94, indirect:0.08, total:1.02, benchmark:ETS_BM.ammonia },
      "3105 20": { sector:"Fertilisers", product:"NPK fertilisers", direct:1.23, indirect:0.11, total:1.35, benchmark:ETS_BM.ammonia },
      "3105 30 00": { sector:"Fertilisers", product:"DAP", direct:0.69, indirect:0.06, total:0.75, benchmark:ETS_BM.ammonia },
      "3105 40 00": { sector:"Fertilisers", product:"MAP", direct:0.44, indirect:0.05, total:0.49, benchmark:ETS_BM.ammonia },
      "3105 51 00": { sector:"Fertilisers", product:"Other N+P", direct:1.29, indirect:0.11, total:1.40, benchmark:ETS_BM.ammonia },
      "3105 59 00": { sector:"Fertilisers", product:"Other N+P (other)", direct:1.29, indirect:0.11, total:1.40, benchmark:ETS_BM.ammonia },
      "3105 90": { sector:"Fertilisers", product:"Other (incl. blends)", direct:0.94, indirect:0.08, total:1.02, benchmark:ETS_BM.ammonia },
      // ALUMINIUM
      "7601": { sector:"Aluminium", product:"Unwrought aluminium", direct:2.36, indirect:8.14, total:10.49, benchmark:ETS_BM.primary_aluminium },
      "7603": { sector:"Aluminium", product:"Aluminium powders and flakes", direct:2.48, indirect:8.40, total:10.88, benchmark:null },
      "7604 10 10": { sector:"Aluminium", product:"Bars/rods of aluminium, not alloyed", direct:2.31, indirect:7.49, total:9.80, benchmark:null },
      "7604 10 90": { sector:"Aluminium", product:"Profiles of aluminium, not alloyed", direct:2.73, indirect:9.30, total:12.04, benchmark:null },
      "7604 21 00": { sector:"Aluminium", product:"Hollow profiles of aluminium alloys", direct:2.73, indirect:9.30, total:12.04, benchmark:null },
      "7604 29 10": { sector:"Aluminium", product:"Bars/rods of aluminium alloys", direct:2.31, indirect:7.49, total:9.80, benchmark:null },
      "7604 29 90": { sector:"Aluminium", product:"Profiles of aluminium alloys", direct:2.73, indirect:9.30, total:12.04, benchmark:null },
      "7605": { sector:"Aluminium", product:"Aluminium wire", direct:2.31, indirect:7.49, total:9.80, benchmark:null },
      "7606": { sector:"Aluminium", product:"Aluminium plates, sheets & strip (>0.2 mm)", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      "7607": { sector:"Aluminium", product:"Aluminium foil (≤0.2 mm)", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      "7608": { sector:"Aluminium", product:"Aluminium tubes and pipes", direct:2.73, indirect:9.30, total:12.04, benchmark:null },
      "7609 00 00": { sector:"Aluminium", product:"Aluminium tube or pipe fittings", direct:2.73, indirect:9.30, total:12.04, benchmark:null },
      "7610": { sector:"Aluminium", product:"Aluminium structures; prepared plates/rods/profiles", direct:2.73, indirect:9.30, total:12.04, benchmark:null },
      "7611 00 00": { sector:"Aluminium", product:"Aluminium reservoirs/tanks/vats >300 l", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      "7612": { sector:"Aluminium", product:"Aluminium casks/drums/cans/boxes ≤300 l", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      "7613 00 00": { sector:"Aluminium", product:"Aluminium containers for compressed or liquefied gas", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      "7614": { sector:"Aluminium", product:"Stranded wire/cables/plaited bands of aluminium", direct:2.31, indirect:7.49, total:9.80, benchmark:null },
      "7616 10 00": { sector:"Aluminium", product:"Aluminium nails/screws/bolts/nuts/washers etc.", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      "7616 91 00": { sector:"Aluminium", product:"Cloth/grill/netting/fencing of aluminium wire", direct:2.31, indirect:7.49, total:9.80, benchmark:null },
      "7616 99 10": { sector:"Aluminium", product:"Other articles of aluminium – Cast", direct:2.48, indirect:8.40, total:10.88, benchmark:null },
      "7616 99 90": { sector:"Aluminium", product:"Other articles of aluminium – Other", direct:2.86, indirect:9.25, total:12.11, benchmark:null },
      // HYDROGEN
      "2804 10 00": { sector:"Hydrogen", product:"Hydrogen", direct:10.4, indirect:0.0, total:10.4, benchmark:ETS_BM.hydrogen },
      // IRON & STEEL
      "2601 12 00": { sector:"Iron & steel", product:"Agglomerated iron ores (sintered)", direct:0.31, indirect:0.05, total:0.36, benchmark:null },
      "7201": { sector:"Iron & steel", product:"Pig iron & spiegeleisen", direct:1.90, indirect:0.17, total:2.07, benchmark:ETS_BM.hot_metal },
      "7202 10": { sector:"Iron & steel", product:"Ferro-manganese", direct:1.44, indirect:2.08, total:3.51, benchmark:null },
      "7202 40": { sector:"Iron & steel", product:"Ferro-chromium", direct:2.08, indirect:3.38, total:5.45, benchmark:null },
      "7202 60": { sector:"Iron & steel", product:"Ferro-nickel", direct:3.49, indirect:2.81, total:6.26, benchmark:null },
      "7203": { sector:"Iron & steel", product:"DRI & other spongy ferrous products", direct:4.81, indirect:0.00, total:4.81, benchmark:null },
      "7206 10 00": { sector:"Iron & steel", product:"Ingots (non-alloy) - crude steel", direct:2.52, indirect:0.23, total:2.75, benchmark:ETS_BM.eaf_carbon_steel },
      "7206 90 00": { sector:"Iron & steel", product:"Other primary forms (non-alloy) - crude steel", direct:1.97, indirect:0.23, total:2.20, benchmark:ETS_BM.eaf_carbon_steel },
      "7208": { sector:"Iron & steel", product:"Flat non-alloy ≥600mm hot-rolled", direct:2.01, indirect:0.27, total:2.28, benchmark:null },
      "7209": { sector:"Iron & steel", product:"Flat non-alloy ≥600mm cold-rolled", direct:2.03, indirect:0.36, total:2.39, benchmark:null },
      "7210": { sector:"Iron & steel", product:"Flat non-alloy ≥600mm coated", direct:1.97, indirect:0.39, total:2.35, benchmark:null },
      "7219 11 00": { sector:"Iron & steel", product:"Stainless flat ≥600mm >10mm", direct:2.18, indirect:1.90, total:4.08, benchmark:ETS_BM.eaf_high_alloy_steel },
      "7220 11 00": { sector:"Iron & steel", product:"Stainless flat <600mm ≥4.75mm", direct:2.18, indirect:1.90, total:4.08, benchmark:ETS_BM.eaf_high_alloy_steel },
      "7221": { sector:"Iron & steel", product:"Bars & rods, hot-rolled, in coils (stainless)", direct:2.14, indirect:2.17, total:4.30, benchmark:ETS_BM.eaf_high_alloy_steel },
      "7222 30": { sector:"Iron & steel", product:"Other bars & rods (stainless)", direct:2.51, indirect:2.10, total:4.61, benchmark:ETS_BM.eaf_high_alloy_steel },
      "7223 00": { sector:"Iron & steel", product:"Wire of stainless steel", direct:2.13, indirect:2.36, total:4.49, benchmark:ETS_BM.eaf_high_alloy_steel },
      "7308": { sector:"Iron & steel", product:"Structures & parts of structures", direct:2.46, indirect:2.55, total:5.01, benchmark:null },
      "7326": { sector:"Iron & steel", product:"Other articles of iron or steel", direct:2.46, indirect:2.55, total:5.01, benchmark:null }
    };

    const productCategories = { steel:'Stahl & Eisen', aluminium:'Aluminium', cement:'Zement', fertilizer:'Düngemittel', custom:'Andere' };
    const cbamDefaultValues = { steel:2.10, aluminium:2.36, cement:0.97, fertilizer:1.90, custom:2.00 };

    // Store questions for submission
    const questions = [
      "CBAM-Deklarant-Autorisierung",
      "Lieferanten-Datensammlung & -management",
      "CBAM-Registry & Berichtssystem",
      "Interne CBAM-Organisation & Prozesse",
      "Finanzplanung für CBAM-Zertifikate",
      "Verifizierung & Audit-Bereitschaft",
      "Rechtliche & Compliance-Expertise",
      "IT-Systeme & Datenmanagement"
    ];

    const cnIndex = (() => {
      const idx = {};
      for (const [k, v] of Object.entries(cnCodeDatabaseRaw)) {
        const key1 = k.trim();
        const key2 = key1.replace(/\s+/g,'');
        idx[key1] = v;
        idx[key2] = v;
      }
      return idx;
    })();

    function findCN(cn) {
      if (!cn) return null;
      const s = cn.trim();
      const noSpace = s.replace(/\s+/g,'');
      if (cnIndex[s]) return cnIndex[s];
      if (cnIndex[noSpace]) return cnIndex[noSpace];
      const m = noSpace.match(/^(\d{4})(\d{2})?(\d{2})?/);
      if (!m) return null;
      const tryKeys = [];
      if (m[1]) tryKeys.push(m[1], m[1]);
      if (m[1] && m[2]) tryKeys.push(`${m[1]}${m[2]}`, `${m[1]} ${m[2]}`);
      if (m[1] && m[2] && m[3]) tryKeys.push(`${m[1]}${m[2]}${m[3]}`, `${m[1]} ${m[2]} ${m[3]}`);
      for (const k of tryKeys) if (cnIndex[k]) return cnIndex[k];
      return null;
    }

    function addProduct() {
      productCounter++;
      const container = document.getElementById('products-container');
      const id = productCounter;

      const productDiv = document.createElement('div');
      productDiv.className = 'product-item';
      productDiv.id = `product-${id}`;

      productDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h4 style="margin:0; color:#060496;">Produkt ${id}</h4>
          <button type="button" onclick="removeProduct(${id})" style="background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">Entfernen</button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px;">
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">CN/HS-Code (optional):</label>
            <input type="text" id="cncode-${id}" placeholder="z.B. 7208 oder 7603 00 00" onchange="updateFromCNCode(${id})" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Produktkategorie:</label>
            <select id="category-${id}" onchange="updateProductType(${id})" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
              <option value="">Wählen...</option>
              <option value="steel">Stahl & Eisen</option>
              <option value="aluminium">Aluminium</option>
              <option value="cement">Zement</option>
              <option value="fertilizer">Düngemittel</option>
              <option value="custom">Andere</option>
            </select>
          </div>
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Jährliche Tonnage:</label>
            <input type="number" id="tonnage-${id}" placeholder="z.B. 1000" min="0" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Emissionsfaktor (tCO₂/t):</label>
            <input type="number" id="emissions-${id}" step="0.01" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
          </div>
          <div>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Benchmark (tCO₂/t):</label>
            <input type="number" id="benchmark-${id}" step="0.001" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; background:#f8f9fa;" readonly>
          </div>
        </div>
        <input type="hidden" id="direct-${id}" />
        <input type="hidden" id="indirect-${id}" />
        <div id="product-info-${id}" style="margin-top:10px; padding:10px; background:#e3f2fd; border-radius:5px; display:none;">
          <small id="product-details-${id}"></small>
        </div>
      `;
      container.appendChild(productDiv);
    }

    function removeProduct(id) {
      const el = document.getElementById(`product-${id}`);
      if (el) el.remove();
      updateCostSummary();
    }

    function applyEffectiveEmissions(id) {
      const dir = parseFloat(document.getElementById(`direct-${id}`).value || '0');
      document.getElementById(`emissions-${id}`).value = dir ? dir.toFixed(2) : '';
    }

    function updateFromCNCode(id) {
      const cnRaw = document.getElementById(`cncode-${id}`).value;
      const data = findCN(cnRaw);
      const categorySelect = document.getElementById(`category-${id}`);
      const emissionsInput = document.getElementById(`emissions-${id}`);
      const benchmarkInput = document.getElementById(`benchmark-${id}`);
      const directInput = document.getElementById(`direct-${id}`);
      const indirectInput = document.getElementById(`indirect-${id}`);
      const infoBox = document.getElementById(`product-info-${id}`);
      const details = document.getElementById(`product-details-${id}`);

      if (data) {
        const categoryMapping = { 'Cement':'cement', 'Fertilisers':'fertilizer', 'Aluminium':'aluminium', 'Hydrogen':'custom', 'Iron & steel':'steel' };
        categorySelect.value = categoryMapping[data.sector] || 'custom';

        directInput.value = (data.direct ?? 0);
        indirectInput.value = (data.indirect ?? 0);
        emissionsInput.value = (data.direct ?? 0).toFixed(2);

        benchmarkInput.value = data.benchmark ? Number(data.benchmark).toFixed(3) : 0;

        details.innerHTML = `<strong>${data.product}</strong> — Sektor: ${data.sector}<br>
          Direkte Emissionen: ${(data.direct ?? 0).toFixed(2)} tCO₂/t | Indirekte: ${(data.indirect ?? 0).toFixed(2)} tCO₂/t |
          Benchmark: ${data.benchmark ? data.benchmark.toFixed(3)+' tCO₂/t' : '—'}`;
        infoBox.style.display = 'block';
      } else if (cnRaw.trim()) {
        details.innerHTML = `CN-Code "${cnRaw}" nicht in der Datenbank gefunden. Bitte Kategorie manuell auswählen.`;
        infoBox.style.display = 'block';
        directInput.value = '';
        indirectInput.value = '';
        emissionsInput.value = '';
        benchmarkInput.value = 0;
      } else {
        infoBox.style.display = 'none';
        directInput.value = '';
        indirectInput.value = '';
        emissionsInput.value = '';
        benchmarkInput.value = 0;
      }
    }

    function updateProductType(id) {
      const category = document.getElementById(`category-${id}`).value;
      const cncode = document.getElementById(`cncode-${id}`).value.trim();
      const benchmarkInput = document.getElementById(`benchmark-${id}`);
      const directInput = document.getElementById(`direct-${id}`);
      const indirectInput = document.getElementById(`indirect-${id}`);
      const emissionsInput = document.getElementById(`emissions-${id}`);

      if (cncode && findCN(cncode)) return;

      if (category && cbamDefaultValues[category]) {
        emissionsInput.value = cbamDefaultValues[category].toFixed(2);
        directInput.value = cbamDefaultValues[category];
        indirectInput.value = 0;
        benchmarkInput.value = 0;
      }
    }

    function updateProductCostPreview(id) {
      const tonnage = parseFloat(document.getElementById(`tonnage-${id}`).value || '0');
      const emissions = parseFloat(document.getElementById(`emissions-${id}`).value || '0');
      const benchmark = parseFloat(document.getElementById(`benchmark-${id}`).value || '0');
      const preview = document.getElementById(`cost-preview-${id}`);
      const costText = document.getElementById(`cost-text-${id}`);

      if (tonnage > 0 && emissions > 0) {
        const effectiveEmissions = Math.max(0, emissions - benchmark);
        const cost2026 = tonnage * effectiveEmissions * co2Prices[2026] * cbamPhaseIn[2026];
        costText.textContent = `€${cost2026.toLocaleString('de-DE', {maximumFractionDigits: 0})}`;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }

    function updateCostSummary() {
      const products = [];
      for (let i = 1; i <= productCounter; i++) {
        const tonnageEl = document.getElementById(`tonnage-${i}`);
        const emissionsEl = document.getElementById(`emissions-${i}`);
        const benchmarkEl = document.getElementById(`benchmark-${i}`);
        
        if (tonnageEl && emissionsEl && benchmarkEl) {
          const tonnage = parseFloat(tonnageEl.value || '0');
          const emissions = parseFloat(emissionsEl.value || '0');
          const benchmark = parseFloat(benchmarkEl.value || '0');
          
          if (tonnage > 0 && emissions > 0) {
            products.push({ id: i, tonnage, emissions, benchmark });
          }
        }
      }

      const summaryDiv = document.getElementById('cost-summary');
      const contentDiv = document.getElementById('total-costs-content');
      const chartContainer = document.getElementById('cost-chart-container');

      if (products.length === 0) {
        summaryDiv.style.display = 'none';
        return;
      }

      let totalCosts = {};
      let totalTonnage = 0;
      
      for (const year of Object.keys(co2Prices)) {
        totalCosts[year] = 0;
      }

      products.forEach(p => {
        totalTonnage += p.tonnage;
        const effectiveEmissions = Math.max(0, p.emissions - p.benchmark);
        
        for (const year of Object.keys(co2Prices)) {
          const yearInt = parseInt(year);
          totalCosts[year] += p.tonnage * effectiveEmissions * co2Prices[yearInt] * cbamPhaseIn[yearInt];
        }
      });

      contentDiv.innerHTML = `
        <p><strong>Gesamttonnage:</strong> ${totalTonnage.toLocaleString('de-DE')} t/Jahr</p>
        <p><strong>Geschätzte CBAM-Kosten 2026:</strong> €${totalCosts[2026].toLocaleString('de-DE', {maximumFractionDigits: 0})}</p>
        <p><strong>Geschätzte CBAM-Kosten 2030:</strong> €${totalCosts[2030].toLocaleString('de-DE', {maximumFractionDigits: 0})}</p>
        <p><strong>Kumulative Kosten 2026-2030:</strong> €${Object.values(totalCosts).slice(0, 5).reduce((a,b) => a+b, 0).toLocaleString('de-DE', {maximumFractionDigits: 0})}</p>
      `;

      // Create cost projection chart
      if (costProjectionChart) {
        costProjectionChart.destroy();
      }

      const years = Object.keys(totalCosts);
      const costs = Object.values(totalCosts);

      const ctx = document.getElementById('costProjectionChart').getContext('2d');
      costProjectionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'CBAM-Kosten (€)',
            data: costs,
            borderColor: '#060496',
            backgroundColor: 'rgba(6, 4, 150, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '€' + value.toLocaleString('de-DE');
                }
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'CBAM-Kostenprognose'
            }
          }
        }
      });

      chartContainer.style.display = 'block';
      summaryDiv.style.display = 'block';
    }

    function selectStatus(element, questionId, status) {
      // Remove selected class from siblings
      const siblings = element.parentNode.querySelectorAll('.status-option');
      siblings.forEach(s => s.classList.remove('selected'));
      
      // Add selected class to clicked element
      element.classList.add('selected');
      
      // Store answer
      analysisAnswers[questionId] = status;
    }

    function validateCompanyInfo() {
      let isValid = true;
      const fields = [
        { id: 'company-name', required: true },
        { id: 'contact-name', required: true },
        { id: 'contact-email', required: true }
      ];

      fields.forEach(field => {
        const input = document.getElementById(field.id);
        const errorDiv = document.getElementById(field.id + '-error');
        
        if (field.required && !input.value.trim()) {
          input.classList.add('validation-error');
          errorDiv.textContent = 'Dieses Feld ist erforderlich';
          isValid = false;
        } else if (field.id === 'contact-email' && input.value.trim() && !input.value.includes('@')) {
          input.classList.add('validation-error');
          errorDiv.textContent = 'Bitte geben Sie eine gültige E-Mail-Adresse ein';
          isValid = false;
        } else {
          input.classList.remove('validation-error');
          errorDiv.textContent = '';
        }
      });

      return isValid;
    }

    function generateResults() {
      if (!validateCompanyInfo()) {
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
        return;
      }

      const totalQuestions = 8;
      const answeredQuestions = Object.keys(analysisAnswers).length;
      
      if (answeredQuestions < totalQuestions) {
        alert(`Bitte beantworten Sie alle ${totalQuestions} Fragen der Gap-Analyse.`);
        return;
      }

      const results = calculateResults();
      displayResults(results);

      submitToGoogleSheets(false, null);
      
      document.getElementById('results').style.display = 'block';
      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }   
    
    function calculateCBAMCosts() {
      if (!validateCompanyInfo()) {
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
        return;
      }
    
      const products = [];
      for (let i = 1; i <= productCounter; i++) {
        const tonnageEl = document.getElementById(`tonnage-${i}`);
        const emissionsEl = document.getElementById(`emissions-${i}`);
        const benchmarkEl = document.getElementById(`benchmark-${i}`);
        const categoryEl = document.getElementById(`category-${i}`);
        const cncodeEl = document.getElementById(`cncode-${i}`);
        
        if (tonnageEl && emissionsEl && benchmarkEl) {
          const tonnage = parseFloat(tonnageEl.value || '0');
          const emissions = parseFloat(emissionsEl.value || '0');
          const benchmark = parseFloat(benchmarkEl.value || '0');
          const category = categoryEl ? categoryEl.value : '';
          const cncode = cncodeEl ? cncodeEl.value : '';
          
          if (tonnage > 0 && emissions > 0) {
            products.push({ 
              id: i, 
              tonnage, 
              emissions, 
              benchmark,
              category: category || 'Nicht angegeben',
              cncode: cncode || 'Nicht angegeben'
            });
          }
        }
      }
    
      if (products.length === 0) {
        alert('Bitte fügen Sie mindestens ein Produkt mit Tonnage und Emissionswerten hinzu.');
        return;
      }
    
      // Calculate costs
      let totalCosts = {};
      let totalTonnage = 0;
      
      for (const year of Object.keys(co2Prices)) {
        totalCosts[year] = 0;
      }
    
      products.forEach(p => {
        totalTonnage += p.tonnage;
        const effectiveEmissions = Math.max(0, p.emissions - p.benchmark);
        
        for (const year of Object.keys(co2Prices)) {
          const yearInt = parseInt(year);
          totalCosts[year] += p.tonnage * effectiveEmissions * co2Prices[yearInt] * cbamPhaseIn[yearInt];
        }
      });
    
      // Display results
      displayCostResults(totalCosts, totalTonnage);
    
      // Submit to Google Sheets with all required data
      submitToGoogleSheets(true, {
        products: products,
        totalTonnage: totalTonnage,
        costs: totalCosts
      });
    }

    function displayCostResults(totalCosts, totalTonnage) {
      const contentDiv = document.getElementById('total-costs-content');
      const chartContainer = document.getElementById('cost-chart-container');
      const summaryDiv = document.getElementById('cost-summary');

      contentDiv.innerHTML = `
        <p><strong>Gesamttonnage:</strong> ${totalTonnage.toLocaleString('de-DE')} t/Jahr</p>
        <p><strong>Geschätzte CBAM-Kosten 2026:</strong> €${totalCosts[2026].toLocaleString('de-DE', {maximumFractionDigits: 0})}</p>
        <p><strong>Geschätzte CBAM-Kosten 2030:</strong> €${totalCosts[2030].toLocaleString('de-DE', {maximumFractionDigits: 0})}</p>
        <p><strong>Kumulative Kosten 2026-2030:</strong> €${Object.values(totalCosts).slice(0, 5).reduce((a,b) => a+b, 0).toLocaleString('de-DE', {maximumFractionDigits: 0})}</p>
      `;

      // Create cost projection chart
      if (costProjectionChart) {
        costProjectionChart.destroy();
      }

      const years = Object.keys(totalCosts);
      const costs = Object.values(totalCosts);

      const ctx = document.getElementById('costProjectionChart').getContext('2d');
      costProjectionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'CBAM-Kosten (€)',
            data: costs,
            borderColor: '#060496',
            backgroundColor: 'rgba(6, 4, 150, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '€' + value.toLocaleString('de-DE');
                }
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'CBAM-Kostenprognose'
            }
          }
        }
      });

      chartContainer.style.display = 'block';
      summaryDiv.style.display = 'block';  
      summaryDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function calculateResults() {
      const scores = { have: 0, partial: 0, need: 0 };
      
      Object.values(analysisAnswers).forEach(answer => {
        scores[answer]++;
      });

      const readinessScore = (scores.have * 2 + scores.partial * 1) / (8 * 2) * 100;
      
      return {
        scores,
        readinessScore: Math.round(readinessScore),
        totalQuestions: 8
      };
    }

    function displayResults(results) {
      const content = document.getElementById('results-content');
      
      let readinessLevel, recommendations;
      
      if (results.readinessScore >= 75) {
        readinessLevel = "Fortgeschrittene Vorbereitung";
        recommendations = [
          "Detaillierte Verifizierung bestehender Systeme durch Experten erforderlich",
          "Komplexe Optimierungsstrategien für Kostenminimierung entwickeln",
          "Spezialisierte Audit-Vorbereitung für 2026",
          "Fortgeschrittene Lieferanten-Dekarbonisierungsstrategien implementieren"
        ];
      } else if (results.readinessScore >= 50) {
        readinessLevel = "Grundlagen vorhanden, spezialisierte Unterstützung erforderlich";
        recommendations = [
          "Professionelle Lückenanalyse und Implementierungsplanung notwendig",
          "Spezialisierte IT-Systemintegration für CBAM-Datenmanagement",
          "Rechtliche Compliance-Struktur durch Experten entwickeln lassen",
          "Komplexe Lieferanten-Engagement-Programme professionell aufsetzen"
        ];
      } else {
        readinessLevel = "Umfassende professionelle Begleitung dringend erforderlich";
        recommendations = [
          "Sofortige professionelle CBAM-Beratung und Projektplanung notwendig",
          "Systematischer Aufbau aller erforderlichen Strukturen durch Experten",
          "Dringende Implementierung von Datensammlung und Compliance-Systemen",
          "Vollständige CBAM-Implementierungsbegleitung durch spezialisierte Berater"
        ];
      }

      content.innerHTML = `
        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:10px; margin-bottom:20px;">
          <h3>CBAM-Bereitschaftsgrad: ${results.readinessScore}%</h3>
          <p><strong>Bewertung:</strong> ${readinessLevel}</p>
          <div style="background:rgba(255,255,255,0.2); padding:15px; border-radius:8px; margin-top:15px;">
            <p><strong>Bewertungsübersicht:</strong></p>
            <p>Bereit: ${results.scores.have} Bereiche</p>
            <p>Teilweise: ${results.scores.partial} Bereiche</p>
            <p>Handlungsbedarf: ${results.scores.need} Bereiche</p>
          </div>
        </div>
        <div class="action-item">
          <h4>Empfohlene professionelle Unterstützung:</h4>
          <ul style="margin-top:10px;">
            ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
          </ul>
          <p style="margin-top:15px; font-style:italic;">CBAM-Compliance erfordert spezialisierte Expertise in regulatorischen, technischen und operativen Bereichen. Die Komplexität der Anforderungen macht professionelle Begleitung für eine erfolgreiche und kostenoptimierte Implementierung unerlässlich.</p>
        </div>
      `;
    }
    
    function submitToGoogleSheets(fromCostCalculator = false, costData = null) {
      if (!validateCompanyInfo()) {
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
        return;
      }


      // Prepare responses array for Apps Script
      const responses = [];
      for (let i = 1; i <= questions.length; i++) {
        if (analysisAnswers[i]) {
          responses.push({
            question: questions[i - 1],
            status: analysisAnswers[i]
          });
        }
      }

      // Get primary sector from products if available
      let sector = '';
      let sectorName = '';
      if (costData && costData.products && costData.products.length > 0) {
        const primaryProduct = costData.products[0];
        sector = primaryProduct.category;
        sectorName = productCategories[primaryProduct.category] || primaryProduct.category;
      }

      // Calculate readiness if gap analysis was done
      let readinessScore = 0;
      let readinessLevel = '';
      if (responses.length > 0) {
        const results = calculateResults();
        readinessScore = results.readinessScore;
        if (readinessScore >= 75) {
          readinessLevel = "Hoch";
        } else if (readinessScore >= 50) {
          readinessLevel = "Mittel";  
        } else {
          readinessLevel = "Niedrig";
        }
      }

      // Prepare complete data object matching Apps Script expectations
      const dataToSubmit = {
        language: 'de',
        timestamp: new Date().toISOString(),
        companyName: document.getElementById('company-name').value,
        sector: sector,
        sectorName: sectorName,
        exportVolume: costData ? costData.totalTonnage : 0,
        contactName: document.getElementById('contact-name').value,
        email: document.getElementById('contact-email').value,
        euBuyers: document.getElementById('eu-buyers').value,
        readinessScore: readinessScore,
        readinessLevel: readinessLevel,
        estimatedCost2026: costData ? Math.round(costData.costs[2026]) : 0,
        estimatedCost2030: costData ? Math.round(costData.costs[2030]) : 0,
        estimatedCost2034: costData ? Math.round(costData.costs[2034]) : 0,
        responses: responses
      };

      // Google Sheets submission
      const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyTAIAVtW6nEIoyrffW2yk9XYH1Cw8UbpnlWA-MA-LUMe3VITZw2F-q9gltSu33oINSdw/exec';
      
      console.log('Data to submit:', dataToSubmit);
      
      // Submit to Google Sheets
      fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSubmit)
      }).then(() => {
        if (fromCostCalculator) {
          alert('Kostenschätzung wurde erfolgreich berechnet und Ihre Daten gespeichert.');
        } else {
          alert('Vielen Dank! Ihre Gap-Analyse wurde erfolgreich übermittelt. Wir werden uns in Kürze bei Ihnen melden.');
        }
      }).catch(error => {
        console.error('Error submitting to Google Sheets:', error);
        alert('Die Daten wurden verarbeitet, aber es gab ein Problem bei der Übertragung. Bitte versuchen Sie es erneut oder kontaktieren Sie uns direkt.');
      });
    }

    // Initialize with one product
    window.onload = function() {
      addProduct();
    };
  </script>
</body>
</html>
